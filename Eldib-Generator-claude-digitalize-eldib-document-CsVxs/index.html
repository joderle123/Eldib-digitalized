<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELDiB - Digitale Entwicklungseinsch√§tzung</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .header h1 span {
            color: #3498db;
        }

        .header-subtitle {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 4px;
        }

        .export-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .export-btn:hover {
            background: #219a52;
        }

        /* Profil & Evaluationen Management */
        .profile-bar {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            padding: 12px 40px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .profile-bar label {
            color: white;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-bar select {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            min-width: 180px;
            cursor: pointer;
        }

        .profile-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .profile-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.4);
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .profile-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: white;
        }

        .profile-btn.primary {
            background: #27ae60;
            border-color: #27ae60;
        }

        .profile-btn.primary:hover {
            background: #219a52;
        }

        .profile-btn.danger {
            background: rgba(231,76,60,0.3);
            border-color: #e74c3c;
        }

        .profile-btn.danger:hover {
            background: rgba(231,76,60,0.5);
        }

        .profile-btn.small {
            padding: 4px 8px;
            font-size: 11px;
        }

        .divider {
            border-left: 2px solid rgba(255,255,255,0.3);
            height: 35px;
            margin: 0 5px;
        }

        .evaluation-info {
            margin-left: auto;
            color: white;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .evaluation-count {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .save-indicator {
            display: none;
            color: #2ecc71;
            font-size: 12px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .save-indicator.show {
            display: inline-block;
        }

        /* Vergleichs-Tab */
        .comparison-tab {
            background: #8e44ad;
            color: white;
        }

        .comparison-tab.active {
            background: white;
            color: #8e44ad;
        }

        /* Vergleichs-Ansicht */
        .comparison-section {
            display: none;
            padding: 24px 40px;
            background: white;
        }

        .comparison-section.active {
            display: block;
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #8e44ad;
        }

        .comparison-header h2 {
            color: #8e44ad;
            font-size: 20px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 24px;
        }

        .comparison-table th {
            background: #8e44ad;
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 13px;
        }

        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        .comparison-table tr:hover {
            background: #f8f4fc;
        }

        .delta-positive {
            color: #27ae60;
            font-weight: 600;
        }

        .delta-negative {
            color: #e74c3c;
            font-weight: 600;
        }

        .progress-chart {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .progress-chart h3 {
            color: #2c3e50;
            margin-bottom: 16px;
            font-size: 16px;
        }

        .chart-row {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
        }

        .chart-label {
            width: 120px;
            font-weight: 600;
            font-size: 13px;
        }

        .chart-bars {
            flex: 1;
            display: flex;
            gap: 4px;
            align-items: flex-end;
            height: 60px;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(180deg, #9b59b6 0%, #8e44ad 100%);
            border-radius: 4px 4px 0 0;
            position: relative;
            min-width: 30px;
            transition: all 0.3s;
        }

        .chart-bar:hover {
            opacity: 0.8;
        }

        .chart-bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #666;
            white-space: nowrap;
        }

        .chart-bar-value {
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: 600;
            color: #8e44ad;
        }

        /* Sch√ºlerdaten */
        .student-section {
            background: white;
            padding: 24px 40px;
            border-bottom: 1px solid #e0e0e0;
        }

        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            max-width: 1000px;
        }

        .student-grid label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .student-grid input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            margin-top: 4px;
            transition: border-color 0.2s;
        }

        .student-grid input:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Bereiche Navigation */
        .domain-nav {
            background: white;
            padding: 0 40px;
            display: flex;
            gap: 4px;
            border-bottom: 1px solid #e0e0e0;
            overflow-x: auto;
        }

        .domain-tab {
            padding: 16px 24px;
            border: none;
            background: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .domain-tab:hover {
            background: #f8f9fa;
        }

        .domain-tab.active {
            border-bottom-color: var(--domain-color);
            color: var(--domain-color);
        }

        .domain-tab[data-domain="verhalten"] { --domain-color: #e74c3c; }
        .domain-tab[data-domain="kommunikation"] { --domain-color: #3498db; }
        .domain-tab[data-domain="sozialisation"] { --domain-color: #27ae60; }
        .domain-tab[data-domain="kognition"] { --domain-color: #9b59b6; }

        /* Main Content */
        .main-content {
            padding: 24px 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .domain-section {
            display: none;
        }

        .domain-section.active {
            display: block;
        }

        /* Stufen */
        .stufe-container {
            background: white;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .stufe-header {
            padding: 16px 24px;
            background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stufe-header-text {
            flex: 1;
            min-width: 200px;
        }

        .stufe-header h3 {
            font-size: 16px;
            color: var(--domain-color);
            margin-bottom: 4px;
        }

        .stufe-header p {
            font-size: 13px;
            color: #666;
        }

        .stufe-complete-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .stufe-complete-btn:hover {
            background: #219a52;
            transform: scale(1.02);
        }

        .stufe-complete-btn.completed {
            background: #95a5a6;
        }

        /* Items Liste */
        .items-list {
            padding: 0;
        }

        .item-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            padding: 16px 24px;
            border-bottom: 1px solid #f0f0f0;
            align-items: start;
        }

        .item-row:last-child {
            border-bottom: none;
        }

        .item-row:hover {
            background: #fafafa;
        }

        .item-info {
            min-width: 0;
        }

        .item-code {
            display: inline-block;
            background: var(--domain-color);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin-right: 8px;
        }

        .item-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .item-description {
            font-size: 13px;
            color: #666;
            margin-top: 6px;
            line-height: 1.6;
        }

        /* Checkboxen */
        .item-checkboxes {
            display: flex;
            gap: 12px;
            flex-shrink: 0;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .checkbox-group label {
            font-size: 11px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
        }

        .checkbox-erreicht,
        .checkbox-ziel,
        .checkbox-nicht-erreicht {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 3px solid #ddd;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }

        .checkbox-erreicht:hover {
            border-color: #27ae60;
        }

        .checkbox-ziel:hover {
            border-color: #f39c12;
        }

        .checkbox-erreicht.checked {
            background: #27ae60;
            border-color: #27ae60;
        }

        .checkbox-ziel.checked {
            background: #f39c12;
            border-color: #f39c12;
        }

        .checkbox-erreicht.checked::after,
        .checkbox-ziel.checked::after {
            content: "‚úì";
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        /* Neue Checkbox-Typen */
        .checkbox-nicht-erreicht,
        .checkbox-nicht-erreicht:hover {
            border-color: #95a5a6;
        }

        .checkbox-nicht-erreicht.checked {
            background: #95a5a6;
            border-color: #95a5a6;
        }

        .checkbox-nicht-erreicht.checked::after {
            content: "‚úó";
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        /* Disabled states */
        .checkbox-disabled {
            opacity: 0.3;
            cursor: not-allowed !important;
            pointer-events: none;
        }

        .checkbox-group.disabled label {
            opacity: 0.4;
        }

        /* Item row clickable */
        .item-info {
            cursor: pointer;
        }

        .item-info:hover .item-name {
            color: #3498db;
            text-decoration: underline;
        }

        /* Modal f√ºr Item-Erkl√§rung */
        .item-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .item-modal-overlay.active {
            display: flex;
        }

        .item-modal {
            background: white;
            border-radius: 12px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .item-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-modal-header h3 {
            margin: 0;
            font-size: 18px;
            color: #2c3e50;
        }

        .item-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            line-height: 1;
        }

        .item-modal-close:hover {
            color: #333;
        }

        .item-modal-body {
            padding: 24px;
        }

        .item-modal-code {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .item-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 16px;
        }

        .item-modal-description {
            font-size: 15px;
            line-height: 1.7;
            color: #333;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .item-modal-hint {
            margin-top: 16px;
            font-size: 13px;
            color: #666;
            font-style: italic;
        }

        /* Legende */
        .legend {
            display: flex;
            gap: 24px;
            padding: 16px 24px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 24px;
            font-size: 13px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .legend-dot.erreicht { background: #27ae60; }
        .legend-dot.ziel { background: #f39c12; }

        /* Zusammenfassung */
        .summary-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 12px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .summary-stats {
            display: flex;
            gap: 32px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        .stat-value.erreicht { color: #27ae60; }
        .stat-value.ziel { color: #f39c12; }

        .stat-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header, .student-section, .domain-nav, .main-content {
                padding-left: 16px;
                padding-right: 16px;
            }

            .item-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .item-checkboxes {
                justify-content: flex-start;
            }

            .summary-bar {
                padding: 12px 16px;
            }

            .summary-stats {
                gap: 16px;
            }
        }

        /* Padding f√ºr fixed summary bar */
        .main-content {
            padding-bottom: 100px;
        }

        /* Domain colors als CSS variables */
        [data-domain="verhalten"] { --domain-color: #e74c3c; }
        [data-domain="kommunikation"] { --domain-color: #3498db; }
        [data-domain="sozialisation"] { --domain-color: #27ae60; }
        [data-domain="kognition"] { --domain-color: #9b59b6; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div>
            <h1>ELD<span>i</span>B Digital</h1>
            <p class="header-subtitle">Entwicklungsp√§dagogischer Lernziel-Diagnose-Bogen</p>
        </div>
        <button class="export-btn" onclick="exportToWord()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="12" y1="18" x2="12" y2="12"></line>
                <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
            Word-Dokument exportieren
        </button>
    </header>

    <!-- Profil & Evaluationen Management -->
    <section class="profile-bar">
        <!-- Profil-Gruppe -->
        <div class="profile-group">
            <label>Profil:</label>
            <select id="profileSelect" onchange="loadProfile(this.value)">
                <option value="">-- W√§hlen --</option>
            </select>
            <button class="profile-btn small" onclick="createNewProfile()" title="Neues Profil erstellen">+ Neu</button>
            <button class="profile-btn small danger" onclick="deleteCurrentProfile()" id="deleteProfileBtn" style="display:none;" title="Profil l√∂schen">X</button>
        </div>

        <div class="divider"></div>

        <!-- Evaluationen-Gruppe -->
        <div class="profile-group">
            <label>Evaluation:</label>
            <select id="evaluationSelect" onchange="loadEvaluation(this.value)">
                <option value="">-- W√§hlen --</option>
            </select>
            <button class="profile-btn small" onclick="createNewEvaluation()" title="Neue Evaluation erstellen">+ Neu</button>
            <button class="profile-btn small danger" onclick="deleteCurrentEvaluation()" id="deleteEvalBtn" style="display:none;" title="Evaluation l√∂schen">X</button>
        </div>

        <div class="divider"></div>

        <!-- Speichern-Button -->
        <button class="profile-btn primary" onclick="manualSave()" id="saveBtn" title="Aktuelle Evaluation speichern">
            Speichern
        </button>
        <span class="save-indicator" id="saveIndicator">Gespeichert!</span>

        <!-- Info-Bereich -->
        <div class="evaluation-info">
            <span id="evaluationCount" class="evaluation-count">0 Evaluationen</span>
            <button class="profile-btn" onclick="showComparison()" id="compareBtn" style="display:none;">Vergleich</button>
        </div>
    </section>

    <!-- Sch√ºlerdaten -->
    <section class="student-section">
        <div class="student-grid">
            <div>
                <label>Name des Kindes/Jugendlichen</label>
                <input type="text" id="studentName" placeholder="Vorname Nachname">
            </div>
            <div>
                <label>Geburtsdatum</label>
                <input type="date" id="birthDate">
            </div>
            <div>
                <label>F√∂rderort</label>
                <input type="text" id="foerderort" placeholder="z.B. CDSE">
            </div>
            <div>
                <label>Datum der Einsch√§tzung</label>
                <input type="date" id="assessmentDate">
            </div>
            <div>
                <label>Einsch√§tzende Person</label>
                <input type="text" id="assessorName" placeholder="Name und Funktion">
            </div>
        </div>
    </section>

    <!-- Bereichs-Navigation -->
    <nav class="domain-nav">
        <button class="domain-tab active" data-domain="verhalten" onclick="switchDomain('verhalten')">
            Verhalten
        </button>
        <button class="domain-tab" data-domain="kommunikation" onclick="switchDomain('kommunikation')">
            Kommunikation
        </button>
        <button class="domain-tab" data-domain="sozialisation" onclick="switchDomain('sozialisation')">
            Sozialisation
        </button>
        <button class="domain-tab" data-domain="kognition" onclick="switchDomain('kognition')">
            Kognition
        </button>
        <button class="domain-tab comparison-tab" data-domain="vergleich" onclick="switchDomain('vergleich')" id="comparisonTab" style="display:none;">
            üìä Entwicklungsverlauf
        </button>
    </nav>

    <!-- Vergleichs-Ansicht -->
    <section class="comparison-section" id="comparisonSection">
        <div class="comparison-header">
            <h2>üìä Entwicklungsverlauf √ºber Zeit</h2>
            <span id="comparisonInfo"></span>
        </div>

        <div class="progress-chart" id="progressChart">
            <h3>Entwicklungsalter pro Bereich √ºber Zeit</h3>
            <div id="chartContent">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
        </div>

        <h3 style="margin-bottom: 16px; color: #2c3e50;">Evaluations-√úbersicht</h3>
        <table class="comparison-table" id="comparisonTable">
            <thead>
                <tr>
                    <th>Datum</th>
                    <th>Verhalten</th>
                    <th>Kommunikation</th>
                    <th>Sozialisation</th>
                    <th>Kognition</th>
                    <th>√ò Gesamt</th>
                </tr>
            </thead>
            <tbody id="comparisonTableBody">
                <!-- Wird dynamisch gef√ºllt -->
            </tbody>
        </table>
    </section>

    <!-- Hauptinhalt -->
    <main class="main-content">
        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot" style="background: #27ae60;"></div>
                <span><strong>Erreicht</strong> - F√§higkeit vorhanden</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #95a5a6;"></div>
                <span><strong>Nicht erreicht</strong> - Noch nicht vorhanden</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #f39c12;"></div>
                <span><strong>Ziel</strong> - Aktuelles F√∂rderziel</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #3498db;"></div>
                <span><strong>Ressource</strong> - St√§rke/Ressource</span>
            </div>
            <div class="legend-item" style="margin-left: auto; font-size: 12px; color: #888;">
                <span>Doppelklick auf Item = Details anzeigen</span>
            </div>
        </div>

        <div id="domainContent">
            <!-- Wird dynamisch gef√ºllt -->
        </div>
    </main>

    <!-- Modal f√ºr Item-Details -->
    <div class="item-modal-overlay" id="itemModal" onclick="closeItemModal(event)">
        <div class="item-modal" onclick="event.stopPropagation()">
            <div class="item-modal-header">
                <h3>Item-Details</h3>
                <button class="item-modal-close" onclick="closeItemModal()">&times;</button>
            </div>
            <div class="item-modal-body">
                <span class="item-modal-code" id="modalItemCode"></span>
                <div class="item-modal-title" id="modalItemTitle"></div>
                <div class="item-modal-description" id="modalItemDescription"></div>
                <div class="item-modal-hint">Tipp: Klicken Sie au√üerhalb des Fensters oder dr√ºcken Sie ESC zum Schlie√üen.</div>
            </div>
        </div>
    </div>

    <!-- Zusammenfassung -->
    <div class="summary-bar">
        <div class="summary-stats">
            <div class="stat-item">
                <div class="stat-value erreicht" id="totalErreicht">0</div>
                <div class="stat-label">Erreicht</div>
            </div>
            <div class="stat-item">
                <div class="stat-value ziel" id="totalZiele">0</div>
                <div class="stat-label">Ziele</div>
            </div>
        </div>
        <button class="export-btn" onclick="exportToWord()">
            Word-Dokument exportieren
        </button>
    </div>

    <script>
// ==========================================
// Profil & Evaluationen Management
// ==========================================
let allProfiles = {};  // Alle Sch√ºlerprofile
let currentProfileId = null;
let currentEvaluationId = null;

function generateId() {
    return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function createNewProfile() {
    const name = prompt('Name des Sch√ºlers/der Sch√ºlerin:');
    if (!name || name.trim() === '') return;

    const profileId = generateId();
    allProfiles[profileId] = {
        id: profileId,
        studentData: {
            name: name.trim(),
            birthDate: '',
            foerderort: '',
            assessorName: ''
        },
        evaluations: []
    };

    saveAllProfiles();
    updateProfileDropdown();
    loadProfile(profileId);

    // Automatisch erste Evaluation erstellen
    createNewEvaluation();
}

function loadProfile(profileId) {
    if (!profileId) {
        currentProfileId = null;
        currentEvaluationId = null;
        document.getElementById('deleteProfileBtn').style.display = 'none';
        document.getElementById('evaluationSelect').innerHTML = '<option value="">-- Evaluation w√§hlen --</option>';
        updateEvaluationUI();
        return;
    }

    currentProfileId = profileId;
    const profile = allProfiles[profileId];

    // Stammdaten laden
    document.getElementById('studentName').value = profile.studentData.name || '';
    document.getElementById('birthDate').value = profile.studentData.birthDate || '';
    document.getElementById('foerderort').value = profile.studentData.foerderort || '';

    document.getElementById('deleteProfileBtn').style.display = 'inline-block';

    updateEvaluationDropdown();

    // Letzte Evaluation laden falls vorhanden
    if (profile.evaluations.length > 0) {
        loadEvaluation(profile.evaluations[profile.evaluations.length - 1].id);
    } else {
        currentEvaluationId = null;
        resetAssessments();
        updateEvaluationUI();
    }
}

function deleteCurrentProfile() {
    if (!currentProfileId) return;
    const profile = allProfiles[currentProfileId];
    if (!confirm(`Profil "${profile.studentData.name}" und alle ${profile.evaluations.length} Evaluationen l√∂schen?`)) return;

    delete allProfiles[currentProfileId];
    currentProfileId = null;
    currentEvaluationId = null;

    saveAllProfiles();
    updateProfileDropdown();
    document.getElementById('profileSelect').value = '';
    loadProfile('');
}

function createNewEvaluation() {
    if (!currentProfileId) {
        alert('Bitte zuerst ein Sch√ºlerprofil erstellen oder ausw√§hlen.');
        return;
    }

    const today = new Date().toISOString().split('T')[0];
    const evaluationId = generateId();

    const newEvaluation = {
        id: evaluationId,
        date: today,
        assessorName: document.getElementById('assessorName').value || '',
        assessments: JSON.parse(JSON.stringify(assessments)), // Deep copy
        developmentalAges: null // Wird beim Speichern berechnet
    };

    // Bisherige Bewertungen als Ausgangspunkt (falls gew√ºnscht)
    const profile = allProfiles[currentProfileId];
    if (profile.evaluations.length > 0) {
        const copyPrevious = confirm('Vorherige Bewertungen als Ausgangspunkt √ºbernehmen?');
        if (copyPrevious) {
            const lastEval = profile.evaluations[profile.evaluations.length - 1];
            newEvaluation.assessments = JSON.parse(JSON.stringify(lastEval.assessments));
        }
    }

    profile.evaluations.push(newEvaluation);
    saveAllProfiles();
    updateEvaluationDropdown();
    loadEvaluation(evaluationId);
}

function loadEvaluation(evaluationId) {
    if (!currentProfileId || !evaluationId) {
        currentEvaluationId = null;
        document.getElementById('deleteEvalBtn').style.display = 'none';
        updateEvaluationUI();
        return;
    }

    const profile = allProfiles[currentProfileId];
    const evaluation = profile.evaluations.find(e => e.id === evaluationId);

    if (!evaluation) return;

    currentEvaluationId = evaluationId;

    // Bewertungen laden
    Object.keys(evaluation.assessments).forEach(domain => {
        if (assessments[domain]) {
            Object.assign(assessments[domain], evaluation.assessments[domain]);
        }
    });

    // Datum und Bewerter laden
    document.getElementById('assessmentDate').value = evaluation.date || '';
    document.getElementById('assessorName').value = evaluation.assessorName || '';

    document.getElementById('deleteEvalBtn').style.display = 'inline-block';

    renderAllDomains();
    updateStats();
    updateEvaluationUI();
}

function deleteCurrentEvaluation() {
    if (!currentProfileId || !currentEvaluationId) return;

    const profile = allProfiles[currentProfileId];
    const evalIndex = profile.evaluations.findIndex(e => e.id === currentEvaluationId);

    if (evalIndex === -1) return;

    const evalDate = profile.evaluations[evalIndex].date;
    if (!confirm(`Evaluation vom ${new Date(evalDate).toLocaleDateString('de-DE')} l√∂schen?`)) return;

    profile.evaluations.splice(evalIndex, 1);
    currentEvaluationId = null;

    saveAllProfiles();
    updateEvaluationDropdown();

    // Letzte Evaluation laden falls vorhanden
    if (profile.evaluations.length > 0) {
        loadEvaluation(profile.evaluations[profile.evaluations.length - 1].id);
    } else {
        resetAssessments();
        updateEvaluationUI();
    }
}

function saveCurrentEvaluation() {
    if (!currentProfileId || !currentEvaluationId) return;

    const profile = allProfiles[currentProfileId];
    const evaluation = profile.evaluations.find(e => e.id === currentEvaluationId);

    if (!evaluation) return;

    // Stammdaten aktualisieren
    profile.studentData.name = document.getElementById('studentName').value;
    profile.studentData.birthDate = document.getElementById('birthDate').value;
    profile.studentData.foerderort = document.getElementById('foerderort').value;

    // Evaluation aktualisieren
    evaluation.date = document.getElementById('assessmentDate').value;
    evaluation.assessorName = document.getElementById('assessorName').value;
    evaluation.assessments = JSON.parse(JSON.stringify(assessments));

    // Entwicklungsalter berechnen und speichern
    evaluation.developmentalAges = calculateAllDevelopmentalAges();

    saveAllProfiles();
    updateProfileDropdown(); // Name k√∂nnte sich ge√§ndert haben
}

function manualSave() {
    if (!currentProfileId) {
        alert('Bitte zuerst ein Sch√ºlerprofil erstellen oder ausw√§hlen.');
        return;
    }
    if (!currentEvaluationId) {
        alert('Bitte zuerst eine Evaluation erstellen.');
        return;
    }

    saveCurrentEvaluation();

    // Visuelles Feedback
    const indicator = document.getElementById('saveIndicator');
    indicator.classList.add('show');
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 2000);
}

// Hilfsfunktion f√ºr Farbschattierungen (f√ºr Word-Export)
function getColorShades(baseColor) {
    // Gibt ein Array von Farben zur√ºck: [hellste, ..., dunkelste (original)]
    const shades = {
        '#e74c3c': ['#fadbd8', '#f5b7b1', '#f1948a', '#ec7063', '#e74c3c'], // Rot
        '#3498db': ['#d4e6f1', '#a9cce3', '#7fb3d5', '#5499c7', '#3498db'], // Blau
        '#27ae60': ['#d4efdf', '#a9dfbf', '#7dcea0', '#52be80', '#27ae60'], // Gr√ºn
        '#9b59b6': ['#e8daef', '#d2b4de', '#bb8fce', '#a569bd', '#9b59b6']  // Lila
    };
    return shades[baseColor] || [baseColor, baseColor, baseColor, baseColor, baseColor];
}

function calculateAllDevelopmentalAges() {
    const stageData = {};
    Object.keys(ELDIB_DATA).forEach(domain => {
        stageData[domain] = {};
        ELDIB_DATA[domain].stufen.forEach(stufe => {
            stageData[domain][stufe.nummer] = {
                total: stufe.items.length,
                erreicht: 0
            };
            stufe.items.forEach(item => {
                if (assessments[domain][item.id].erreicht) {
                    stageData[domain][stufe.nummer].erreicht++;
                }
            });
        });
    });

    const result = {};
    Object.keys(ELDIB_DATA).forEach(domain => {
        let highestStage = 0;
        for (let i = 5; i >= 1; i--) {
            if (stageData[domain][i].erreicht > 0) {
                highestStage = i;
                break;
            }
        }
        const devAge = calculateDevelopmentalAge(highestStage, stageData, domain);
        result[domain] = devAge.age;
    });

    return result;
}

function resetAssessments() {
    Object.keys(ELDIB_DATA).forEach(domain => {
        ELDIB_DATA[domain].stufen.forEach(stufe => {
            stufe.items.forEach(item => {
                assessments[domain][item.id] = { erreicht: false, nichtErreicht: false, ziel: false };
            });
        });
    });
    renderAllDomains();
    updateStats();
}

function updateProfileDropdown() {
    const select = document.getElementById('profileSelect');
    const currentValue = select.value;

    select.innerHTML = '<option value="">-- Profil w√§hlen --</option>';

    Object.values(allProfiles)
        .sort((a, b) => a.studentData.name.localeCompare(b.studentData.name))
        .forEach(profile => {
            const option = document.createElement('option');
            option.value = profile.id;
            option.textContent = profile.studentData.name + ` (${profile.evaluations.length} Eval.)`;
            select.appendChild(option);
        });

    if (currentProfileId && allProfiles[currentProfileId]) {
        select.value = currentProfileId;
    }
}

function updateEvaluationDropdown() {
    const select = document.getElementById('evaluationSelect');
    select.innerHTML = '<option value="">-- Evaluation w√§hlen --</option>';

    if (!currentProfileId) return;

    const profile = allProfiles[currentProfileId];
    profile.evaluations
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .forEach((evaluation, index) => {
            const option = document.createElement('option');
            option.value = evaluation.id;
            const date = new Date(evaluation.date).toLocaleDateString('de-DE');
            option.textContent = `${index + 1}. Evaluation - ${date}`;
            select.appendChild(option);
        });

    if (currentEvaluationId) {
        select.value = currentEvaluationId;
    }
}

function updateEvaluationUI() {
    const profile = currentProfileId ? allProfiles[currentProfileId] : null;
    const evalCount = profile ? profile.evaluations.length : 0;

    document.getElementById('evaluationCount').textContent = evalCount + ' Evaluation' + (evalCount !== 1 ? 'en' : '');

    // Vergleichs-Button und Tab anzeigen wenn mehr als 1 Evaluation
    const showComparison = evalCount > 1;
    document.getElementById('compareBtn').style.display = showComparison ? 'inline-block' : 'none';
    document.getElementById('comparisonTab').style.display = showComparison ? 'inline-block' : 'none';
}

function showComparison() {
    switchDomain('vergleich');
}

function renderComparison() {
    if (!currentProfileId) return;

    const profile = allProfiles[currentProfileId];
    const evaluations = profile.evaluations.sort((a, b) => new Date(a.date) - new Date(b.date));

    if (evaluations.length < 2) return;

    // Info
    document.getElementById('comparisonInfo').textContent =
        `${profile.studentData.name} - ${evaluations.length} Evaluationen`;

    // Tabelle f√ºllen
    const tbody = document.getElementById('comparisonTableBody');
    tbody.innerHTML = '';

    evaluations.forEach((evaluation, index) => {
        const row = document.createElement('tr');
        const date = new Date(evaluation.date).toLocaleDateString('de-DE');
        const ages = evaluation.developmentalAges || {};

        // Deltas berechnen
        let deltas = { verhalten: '', kommunikation: '', sozialisation: '', kognition: '' };
        if (index > 0) {
            const prevAges = evaluations[index - 1].developmentalAges || {};
            ['verhalten', 'kommunikation', 'sozialisation', 'kognition'].forEach(domain => {
                if (ages[domain] && prevAges[domain]) {
                    const diff = ages[domain] - prevAges[domain];
                    if (diff !== 0) {
                        deltas[domain] = diff > 0 ?
                            `<span class="delta-positive">+${diff.toFixed(1)}</span>` :
                            `<span class="delta-negative">${diff.toFixed(1)}</span>`;
                    }
                }
            });
        }

        const avg = ['verhalten', 'kommunikation', 'sozialisation', 'kognition']
            .map(d => ages[d] || 0)
            .filter(a => a > 0);
        const avgVal = avg.length > 0 ? (avg.reduce((a, b) => a + b, 0) / avg.length).toFixed(1) : '-';

        row.innerHTML = `
            <td><strong>${date}</strong></td>
            <td>${ages.verhalten?.toFixed(1) || '-'} J. ${deltas.verhalten}</td>
            <td>${ages.kommunikation?.toFixed(1) || '-'} J. ${deltas.kommunikation}</td>
            <td>${ages.sozialisation?.toFixed(1) || '-'} J. ${deltas.sozialisation}</td>
            <td>${ages.kognition?.toFixed(1) || '-'} J. ${deltas.kognition}</td>
            <td><strong>${avgVal} J.</strong></td>
        `;
        tbody.appendChild(row);
    });

    // Chart rendern
    renderProgressChart(evaluations);
}

function renderProgressChart(evaluations) {
    const chartContent = document.getElementById('chartContent');
    const domains = ['verhalten', 'kommunikation', 'sozialisation', 'kognition'];
    const domainNames = { verhalten: 'Verhalten', kommunikation: 'Kommunikation', sozialisation: 'Sozialisation', kognition: 'Kognition' };
    const domainColors = { verhalten: '#e74c3c', kommunikation: '#3498db', sozialisation: '#27ae60', kognition: '#9b59b6' };

    const maxAge = 16;

    let html = '';
    domains.forEach(domain => {
        html += `<div class="chart-row">
            <div class="chart-label" style="color: ${domainColors[domain]};">${domainNames[domain]}</div>
            <div class="chart-bars">`;

        evaluations.forEach(evaluation => {
            const age = evaluation.developmentalAges?.[domain] || 0;
            const height = Math.max(5, (age / maxAge) * 100);
            const date = new Date(evaluation.date).toLocaleDateString('de-DE', { month: 'short', year: '2-digit' });

            html += `<div class="chart-bar" style="height: ${height}%; background: ${domainColors[domain]};">
                <span class="chart-bar-value">${age > 0 ? age.toFixed(1) : '-'}</span>
                <span class="chart-bar-label">${date}</span>
            </div>`;
        });

        html += `</div></div>`;
    });

    chartContent.innerHTML = html;
}

function saveAllProfiles() {
    localStorage.setItem('eldib_profiles_v3', JSON.stringify(allProfiles));
}

function loadAllProfiles() {
    const saved = localStorage.getItem('eldib_profiles_v3');
    if (saved) {
        try {
            allProfiles = JSON.parse(saved);
        } catch (e) {
            console.error('Error loading profiles:', e);
            allProfiles = {};
        }
    }
}

// ==========================================
// ELDiB Daten
// ==========================================
const ELDIB_DATA = {
    verhalten: {
        name: "Verhalten",
        code: "V",
        color: "#e74c3c",
        stufen: [
            {
                nummer: 1,
                stufenziel: "Mit Freude auf die Umwelt reagieren",
                bereichsziel: "Den eigenen k√∂rperlichen F√§higkeiten vertrauen",
                items: [
                    { id: "V-1", name: "Wahrnehmung", beschreibung: "L√§sst Wahrnehmung eines sensorischen Reizes erkennen durch beliebige Bewegungsreaktionen von der Reizquelle weg oder zu ihr hin." },
                    { id: "V-2", name: "Orientierung", beschreibung: "Reagiert auf sensorischen Reiz mit Zuwendung zur Reizquelle, entweder durch k√∂rperliche Reaktion oder durch Hinsehen." },
                    { id: "V-3", name: "Aufmerksamkeit", beschreibung: "Reagiert auf einen Reiz mit kurzzeitig anhaltender Aufmerksamkeit." },
                    { id: "V-4", name: "Motorische Reaktion", beschreibung: "Reagiert von sich aus auf einfache Umgebungsreize mit einer motorischen Handlung." },
                    { id: "V-5", name: "Komplexe Reaktion", beschreibung: "Reagiert auf komplexe Umgebungsreize und verbale Impulse mit motorischer Handlung." },
                    { id: "V-6", name: "Selbsthilfe", beschreibung: "Beteiligt sich aktiv am Erlernen von Selbsthilfe-F√§higkeiten (H√§nde waschen, essen, Toilette, anziehen)." },
                    { id: "V-7", name: "Spielmaterial", beschreibung: "Reagiert eigenst√§ndig auf verschiedene Spielmaterialien." },
                    { id: "V-8", name: "Routineabl√§ufe", beschreibung: "Zeigt Wiedererkennen von Routineabl√§ufen durch eigenst√§ndigen Wechsel von einem Aktivit√§tsbereich zum n√§chsten." }
                ]
            },
            {
                nummer: 2,
                stufenziel: "Erfolgreich auf die Umwelt reagieren",
                bereichsziel: "Erfolgreich an Routineabl√§ufen und Aktivit√§ten teilnehmen",
                items: [
                    { id: "V-9", name: "Spielerfahrung", beschreibung: "Geht mit Spielmaterialien sachgerecht um." },
                    { id: "V-10", name: "Warten", beschreibung: "Wartet ohne k√∂rperliche Steuerungshilfe durch den Erwachsenen." },
                    { id: "V-11", name: "Sitzen", beschreibung: "Beteiligt sich verbal und physisch an Aktivit√§ten im Sitzen ohne k√∂rperliche Steuerungshilfe." },
                    { id: "V-12", name: "Bewegung", beschreibung: "Beteiligt sich verbal und physisch an Bewegungsaktivit√§ten ohne k√∂rperliche Steuerungshilfe." },
                    { id: "V-13", name: "Aktivit√§ten", beschreibung: "Nimmt von sich aus verbal und physisch an Aktivit√§ten teil." },
                    { id: "V-14", name: "Lob/Erfolg", beschreibung: "Akzeptiert Lob oder Erfolg ohne unangemessenes Verhalten oder Kontrollverlust." }
                ]
            },
            {
                nummer: 3,
                stufenziel: "Erwerben von F√§higkeiten zur erfolgreichen Teilnahme in Gruppen",
                bereichsziel: "Erworbene F√§higkeiten anwenden, um innerhalb einer Gruppe das eigene Verhalten erfolgreich zu steuern",
                items: [
                    { id: "V-15", name: "Beenden", beschreibung: "Beendet kurze, individuelle Aufgaben mit vertrautem Material selbstst√§ndig." },
                    { id: "V-16", name: "Erwartungen", beschreibung: "L√§sst Bewusstsein f√ºr Verhaltensweisen erkennen, die zu Hause, in der Schule und in der √ñffentlichkeit erwartet werden." },
                    { id: "V-17", name: "Begr√ºndungen", beschreibung: "Nennt Gr√ºnde f√ºr Verhaltenserwartungen." },
                    { id: "V-18", name: "Alternativen", beschreibung: "Beschreibt alternative, angemessenere Verhaltensm√∂glichkeiten f√ºr eine gegebene Situation." },
                    { id: "V-19", name: "Gruppenwahl", beschreibung: "Reagiert angemessen auf Gruppenwahl als Anf√ºhrer bzw. Teilnehmer." },
                    { id: "V-20", name: "Zur√ºckhalten", beschreibung: "H√§lt sich von inakzeptablem Verhalten zur√ºck, wenn andere in der Gruppe die Selbstkontrolle verlieren." },
                    { id: "V-21", name: "Kontrolle", beschreibung: "Beh√§lt w√§hrend der Gruppenaktivit√§ten akzeptable physische und verbale Selbstkontrolle." }
                ]
            },
            {
                nummer: 4,
                stufenziel: "Sich einbringen in Gruppenprozesse",
                bereichsziel: "Pers√∂nliche F√§higkeiten einsetzen, um zum Gruppenerfolg beizutragen",
                items: [
                    { id: "V-22", name: "Fortschritt", beschreibung: "Zeigt beginnendes Bewusstsein f√ºr eigenen Verhaltensfortschritt." },
                    { id: "V-23", name: "Flexibilit√§t", beschreibung: "L√§sst Flexibilit√§t erkennen, wenn Abl√§ufe aufgrund sich √§ndernder Anforderungen umgestaltet werden m√ºssen." },
                    { id: "V-24", name: "Neue Erfahrungen", beschreibung: "Beteiligt sich verbal und physisch kontrolliert an neuen Erfahrungen bzw. Aktivit√§ten." },
                    { id: "V-25", name: "Anwenden", beschreibung: "Wendet alternative, sozial akzeptable Verhaltensweisen an." },
                    { id: "V-26", name: "Provokation", beschreibung: "Reagiert von sich aus auf Provokationen mit verbal und physisch kontrolliertem Verhalten." },
                    { id: "V-27", name: "Verantwortung", beschreibung: "Akzeptiert Verantwortung f√ºr die Folgen des eigenen Verhaltens und eigener Einstellungen." },
                    { id: "V-28", name: "L√∂sungsvorschlag", beschreibung: "Reagiert in kritischen Situationen auf Probleme mit konstruktiven L√∂sungsvorschl√§gen." }
                ]
            },
            {
                nummer: 5,
                stufenziel: "Anwenden von F√§higkeiten in neuen Situationen",
                bereichsziel: "Realen Lebenserfahrungen mit konstruktivem Verhalten begegnen",
                items: [
                    { id: "V-29", name: "Gewohnheiten", beschreibung: "Entwickelt neue pers√∂nliche Gewohnheiten oder F√§higkeiten mit Bezug zur Arbeitswelt." },
                    { id: "V-30", name: "Positive Rolle", beschreibung: "Sucht und entwickelt eine begehrte positive Rolle innerhalb einer Gruppe." },
                    { id: "V-31", name: "Recht/Ordnung", beschreibung: "Zeigt Verst√§ndnis und Akzeptanz von Rechts- und Ordnungsprinzipien in Schule und √ñffentlichkeit." },
                    { id: "V-32", name: "Selbstverantwortung", beschreibung: "Bef√ºrwortet Verfahren zur Selbstverantwortung und Regelung des Gruppenlebens." },
                    { id: "V-33", name: "Einsicht", beschreibung: "L√∂st pers√∂nliche Probleme anhand von Einsicht, Analyse und Generalisierung." }
                ]
            }
        ]
    },
    kommunikation: {
        name: "Kommunikation",
        code: "K",
        color: "#3498db",
        stufen: [
            {
                nummer: 1,
                stufenziel: "Mit Freude auf die Umwelt reagieren",
                bereichsziel: "Gebraucht W√∂rter, um Bed√ºrfnisse zu befriedigen",
                items: [
                    { id: "K-1", name: "Laute", beschreibung: "Produziert Laute (wiederholt eigene Lautmuster, um sich sozial oder imitierend zu √§u√üern)." },
                    { id: "K-2", name: "Sprecher", beschreibung: "Richtet die Aufmerksamkeit auf eine sprechende Person." },
                    { id: "K-3", name: "Verbaler Impuls", beschreibung: "Reagiert auf einen verbalen Impuls mit einer Bewegung oder Handlung." },
                    { id: "K-4", name: "Wort-Ann√§herung", beschreibung: "Reagiert verbal auf Fragen oder Aufforderungen mit erkennbaren Wort-Ann√§herungen." },
                    { id: "K-5", name: "W√∂rter spontan", beschreibung: "Verwendet von sich aus erkennbare W√∂rter, um ein Ereignis oder Objekt zu beschreiben oder zu benennen." },
                    { id: "K-6", name: "W√∂rter Erwachsener", beschreibung: "Produziert einzelne erkennbare W√∂rter, um eine gew√ºnschte Reaktion des Erwachsenen zu erhalten." },
                    { id: "K-7", name: "W√∂rter Peer", beschreibung: "Produziert einzelne erkennbare W√∂rter, um eine erw√ºnschte Reaktion von einem gleichaltrigen Kind zu erhalten." },
                    { id: "K-8", name: "Wortreihung", beschreibung: "Produziert eine sinnvolle Wortsequenz, um von Anderen eine Reaktion zu erhalten." }
                ]
            },
            {
                nummer: 2,
                stufenziel: "Erfolgreich auf die Umwelt reagieren",
                bereichsziel: "Gebraucht W√∂rter, um andere in konstruktiver Weise zu beeinflussen",
                items: [
                    { id: "K-9", name: "Beantworten", beschreibung: "Beantwortet Fragen, Bitten oder Aufforderungen mit erkennbaren, sinnvollen W√∂rtern." },
                    { id: "K-10", name: "Vokabular", beschreibung: "Zeigt ein rezeptives Vokabular, das nicht mehr als zwei Jahre hinter normalen Erwartungen zur√ºckliegt." },
                    { id: "K-11", name: "Wortsequenzen", beschreibung: "Verwendet von sich aus einfache Wortsequenzen, um etwas zu fordern, zu erfragen oder zu erbitten." },
                    { id: "K-12", name: "Austausch Erwachsene", beschreibung: "Verwendet von sich aus W√∂rter, um mit einem Erwachsenen minimale Informationen auszutauschen." },
                    { id: "K-13", name: "Merkmale", beschreibung: "Beschreibt einfache, konkrete Merkmale sowohl von sich als auch von anderen." },
                    { id: "K-14", name: "Austausch Kind", beschreibung: "Verwendet von sich aus W√∂rter, um mit einem anderen Kind minimale Informationen auszutauschen." }
                ]
            },
            {
                nummer: 3,
                stufenziel: "Erwerben von F√§higkeiten zur erfolgreichen Teilnahme in Gruppen",
                bereichsziel: "Gebraucht W√∂rter, um sich auf konstruktive Weise innerhalb einer Gruppe zu √§u√üern",
                items: [
                    { id: "K-15", name: "Pers√∂nliches", beschreibung: "Verwendet von sich aus W√∂rter, um eigene Erfahrungen, Vorstellungen oder Arbeit zu beschreiben." },
                    { id: "K-16", name: "Gef√ºhlsreaktionen", beschreibung: "Verwendet W√∂rter oder Gesten, um angemessene Gef√ºhlsreaktionen auf die Umgebung zu zeigen." },
                    { id: "K-17", name: "Gespr√§che", beschreibung: "Beteiligt sich an Gruppengespr√§chen in einer Weise, die sich nicht st√∂rend auswirkt." },
                    { id: "K-18", name: "Stolz ‚Äì ich", beschreibung: "Verwendet von sich aus W√∂rter, um Stolz auf eigene Arbeit oder Aktivit√§ten zu zeigen." },
                    { id: "K-19", name: "Eigenschaften ‚Äì ich", beschreibung: "Beschreibt charakteristische Eigenschaften, St√§rken und Schw√§chen bei sich selbst." },
                    { id: "K-20", name: "Eigenschaften ‚Äì du", beschreibung: "Beschreibt charakteristische Eigenschaften bei anderen." },
                    { id: "K-21", name: "Gef√ºhle ‚Äì du", beschreibung: "Erkennt Gef√ºhle anderer." },
                    { id: "K-22", name: "Stolz ‚Äì wir", beschreibung: "Verwendet von sich aus W√∂rter, um Stolz auf Gruppenleistungen auszudr√ºcken." }
                ]
            },
            {
                nummer: 4,
                stufenziel: "Sich einbringen in Gruppenprozesse",
                bereichsziel: "Verwendet W√∂rter, um Verst√§ndnis von Gef√ºhlen und Verhaltensweisen zu zeigen",
                items: [
                    { id: "K-23", name: "Kreativit√§t", beschreibung: "Kanalisiert Gef√ºhle oder Erfahrungen durch kreative Ausdrucksmittel wie Kunst, Musik, Tanz." },
                    { id: "K-24", name: "Fortschritt", beschreibung: "Zeigt beginnendes Bewusstsein f√ºr eigenen Verhaltensfortschritt." },
                    { id: "K-25", name: "Beeinflussung", beschreibung: "Erkl√§rt, wie eigenes Verhalten das Verhalten anderer beeinflusst." },
                    { id: "K-26", name: "Gef√ºhle ‚Äì ich", beschreibung: "Verwendet W√∂rter, um in der Gruppe eigene Gef√ºhle auf angemessene Weise auszudr√ºcken." },
                    { id: "K-27", name: "Beziehung", beschreibung: "Verwendet W√∂rter, um positive Beziehungen mit Gleichaltrigen und Erwachsenen anzukn√ºpfen." },
                    { id: "K-28", name: "Unterst√ºtzen", beschreibung: "Verwendet W√∂rter, um eine andere Person zu loben oder pers√∂nlich zu unterst√ºtzen." },
                    { id: "K-29", name: "Relationen", beschreibung: "Beschreibt den Ursache-Wirkungs-Zusammenhang von Gef√ºhlen und Verhalten." }
                ]
            },
            {
                nummer: 5,
                stufenziel: "Anwenden von F√§higkeiten in neuen Situationen",
                bereichsziel: "Verwendet W√∂rter, um Beziehungen auszubauen und zu pflegen",
                items: [
                    { id: "K-30", name: "Komplexe Aussagen", beschreibung: "Formuliert Aussagen, die weitgehend komplex strukturiert und inhaltlich bildhaft oder abstrakt sind." },
                    { id: "K-31", name: "Ausgleich", beschreibung: "W√§hlt bei Provokationen einen Sprachgebrauch, der auf vers√∂hnliche Absichten hindeutet." },
                    { id: "K-32", name: "Anerkennung", beschreibung: "Unterst√ºtzt andere durch Anerkennung ihrer Beitr√§ge." },
                    { id: "K-33", name: "Motive", beschreibung: "Beschreibt verschiedene Motive und Wertvorstellungen in sozialen Situationen." },
                    { id: "K-34", name: "Ideale", beschreibung: "Beschreibt von sich aus eigene Wertvorstellungen, Ideale und √úberzeugungen." },
                    { id: "K-35", name: "Erhalt/Pflege", beschreibung: "Verwendet kommunikative F√§higkeiten, um positive zwischenmenschliche Beziehungen zu erhalten." }
                ]
            }
        ]
    },
    sozialisation: {
        name: "Sozialisation",
        code: "SOZ",
        color: "#27ae60",
        stufen: [
            {
                nummer: 1,
                stufenziel: "Mit Freude auf die Umwelt reagieren",
                bereichsziel: "Einem Erwachsenen gen√ºgend vertrauen, um auf ihn zu reagieren",
                items: [
                    { id: "SOZ-1", name: "Gegenwart", beschreibung: "Ist sich der Gegenwart anderer bewusst." },
                    { id: "SOZ-2", name: "Gerichtetheit", beschreibung: "Richtet Aufmerksamkeit auf Handlungen anderer." },
                    { id: "SOZ-3", name: "Eigenname", beschreibung: "Reagiert, wenn ein Erwachsener den Namen des Kindes nennt." },
                    { id: "SOZ-4", name: "Spiel allein", beschreibung: "Besch√§ftigt sich mit organisiertem Spiel und spielt dabei f√ºr sich allein." },
                    { id: "SOZ-5", name: "Nonverbale Interaktion", beschreibung: "Interagiert nonverbal mit Erwachsenen, um Bed√ºrfnisse auszudr√ºcken." },
                    { id: "SOZ-6", name: "Kommen", beschreibung: "Reagiert auf die Aufforderung des Erwachsenen, zu ihm zu kommen." },
                    { id: "SOZ-7", name: "Aufforderungen", beschreibung: "Zeigt, dass es einzelne verbale Aufforderungen des Erwachsenen versteht." },
                    { id: "SOZ-8", name: "W√∂rter Erwachsener", beschreibung: "Produziert einzelne erkennbare W√∂rter f√ºr eine gew√ºnschte Reaktion des Erwachsenen." },
                    { id: "SOZ-9", name: "Selbst-Bewusstheit", beschreibung: "Zeigt deutliche Anzeichen f√ºr eine beginnende Herausbildung des Selbst." },
                    { id: "SOZ-10", name: "Spiel parallel", beschreibung: "Nimmt von sich aus an parallelem Spiel teil." },
                    { id: "SOZ-11", name: "W√∂rter Peer", beschreibung: "Produziert einzelne erkennbare W√∂rter f√ºr eine Reaktion von einem gleichaltrigen Kind." },
                    { id: "SOZ-12", name: "Kontaktsuche", beschreibung: "Sucht in unterschiedlichen Situationen Kontakt mit einem vertrauten Erwachsenen." }
                ]
            },
            {
                nummer: 2,
                stufenziel: "Erfolgreich auf die Umwelt reagieren",
                bereichsziel: "Sich erfolgreich an Aktivit√§ten beteiligen",
                items: [
                    { id: "SOZ-13", name: "Fantasie", beschreibung: "Besch√§ftigt sich von sich aus mit Fantasie- und 'So-tun-als-ob'-Spielen." },
                    { id: "SOZ-14", name: "Warten", beschreibung: "Wartet ohne k√∂rperliche Steuerungshilfe durch den Erwachsenen." },
                    { id: "SOZ-15", name: "Kontakt", beschreibung: "Zeigt Ans√§tze, einen angemessenen sozialen Kontakt zu einem anderen Kind aufzunehmen." },
                    { id: "SOZ-16", name: "Teilen", beschreibung: "Beteiligt sich an einer Aktivit√§t, die Teilen erfordert." },
                    { id: "SOZ-17", name: "Spiel interaktiv", beschreibung: "Beteiligt sich erfolgreich an interaktivem Spiel mit einem anderen Kind." },
                    { id: "SOZ-18", name: "Kooperation", beschreibung: "Kooperiert selbstst√§ndig mit einem anderen Kind in strukturierten Aktivit√§ten." }
                ]
            },
            {
                nummer: 3,
                stufenziel: "Erwerben von F√§higkeiten zur erfolgreichen Teilnahme in Gruppen",
                bereichsziel: "Gruppenaktivit√§ten als befriedigend erleben",
                items: [
                    { id: "SOZ-19", name: "Abwechseln", beschreibung: "Teilt von sich aus Materialien und wechselt sich mit anderen ab." },
                    { id: "SOZ-20", name: "Nachahmen", beschreibung: "Ahmt von sich aus angemessenes Verhalten eines anderen Kindes nach." },
                    { id: "SOZ-21", name: "Werten", beschreibung: "Bezeichnet einfache soziale Situationen mit wertenden Aussagen (richtig/falsch, gut/schlecht)." },
                    { id: "SOZ-22", name: "Leiten", beschreibung: "Leitet eine Gruppenaktivit√§t oder demonstriert eine Aktivit√§t f√ºr die Gruppe." },
                    { id: "SOZ-23", name: "Vorschlag andere", beschreibung: "Nimmt an einer Aktivit√§t teil, die ein gleichaltriges Kind vorgeschlagen hat." },
                    { id: "SOZ-24", name: "Erfahrungen", beschreibung: "Beschreibt eigene Erfahrungen in der Reihenfolge, in der sie sich ereignet haben." },
                    { id: "SOZ-25", name: "Vorliebe", beschreibung: "L√§sst beginnende Freundschaft erkennen durch Vorliebe f√ºr ein bestimmtes Kind." },
                    { id: "SOZ-26", name: "Unterst√ºtzung", beschreibung: "Sucht von sich aus Hilfe oder Lob durch ein anderes Kind." },
                    { id: "SOZ-27", name: "Gruppenregeln", beschreibung: "Hilft anderen von sich aus bei der Einhaltung von Gruppenregeln." }
                ]
            },
            {
                nummer: 4,
                stufenziel: "Sich einbringen in Gruppenprozesse",
                bereichsziel: "Nimmt von sich aus und erfolgreich als Gruppenmitglied an Aktivit√§ten teil",
                items: [
                    { id: "SOZ-28", name: "Identifizieren", beschreibung: "Identifiziert sich mit erwachsenen F√ºhrungspersonen oder Vorbildern." },
                    { id: "SOZ-29", name: "Gruppenerfahrung", beschreibung: "Beschreibt soziale Gruppenerfahrungen in der Reihenfolge, in der sie sich ereignet haben." },
                    { id: "SOZ-30", name: "Gruppenaktivit√§t", beschreibung: "Schl√§gt von sich aus eine geeignete Gruppenaktivit√§t vor." },
                    { id: "SOZ-31", name: "Verschiedenheit", beschreibung: "Erkennt, wie sich die eigenen sozialen Handlungen von denen anderer Kinder unterscheiden." },
                    { id: "SOZ-32", name: "Respekt", beschreibung: "H√∂rt und respektiert die Vorstellungen, Gedanken und Meinungen anderer." },
                    { id: "SOZ-33", name: "Interesse", beschreibung: "Bekundet offen sein Interesse an der Meinung Gleichaltriger √ºber die eigene Person." },
                    { id: "SOZ-34", name: "L√∂sungsvorschlag", beschreibung: "Reagiert in kritischen Situationen mit konstruktiven L√∂sungsvorschl√§gen." },
                    { id: "SOZ-35", name: "Wertvorstellung", beschreibung: "Erkennt und unterscheidet gegens√§tzliche Werte in sozialen Situationen." },
                    { id: "SOZ-36", name: "Schlussfolgerungen", beschreibung: "Zieht Schlussfolgerungen aus sozialen Situationen." }
                ]
            },
            {
                nummer: 5,
                stufenziel: "Anwenden von F√§higkeiten in neuen Situationen",
                bereichsziel: "Beginnt und pflegt selbst√§ndig dauerhafte und tragf√§hige Beziehungen",
                items: [
                    { id: "SOZ-37", name: "Empathie", beschreibung: "L√§sst erkennen, dass er pers√∂nliche Situationen und Gef√ºhle anderer versteht und achtet." },
                    { id: "SOZ-38", name: "Verschiedene Rollen", beschreibung: "Interagiert erfolgreich mit anderen in unterschiedlichen sozialen Rollen." },
                    { id: "SOZ-39", name: "Prinzipien", beschreibung: "Trifft in sozialen Situationen pers√∂nliche Entscheidungen aufgrund eigener Wertvorstellungen." },
                    { id: "SOZ-40", name: "Selbstverst√§ndnis", beschreibung: "L√§sst realistisches Verst√§ndnis und Einsch√§tzung des eigenen Selbst erkennen." },
                    { id: "SOZ-41", name: "Interpersonalit√§t", beschreibung: "Zeigt die F√§higkeit, dauerhafte und tragf√§hige Beziehungen aufzubauen und zu erhalten." }
                ]
            }
        ]
    },
    kognition: {
        name: "Kognition",
        code: "KOG",
        color: "#9b59b6",
        stufen: [
            {
                nummer: 1,
                stufenziel: "Mit Freude auf die Umwelt reagieren",
                bereichsziel: "Auf die Umgebung reagieren mit gezielten K√∂rperbewegungen und elementaren mentalen Prozessen",
                items: [
                    { id: "KOG-1", name: "Orientierung", beschreibung: "Reagiert auf sensorischen Reiz mit Zuwendung zur Reizquelle." },
                    { id: "KOG-2", name: "Aufmerksamkeit", beschreibung: "Reagiert auf einen Reiz mit kurzzeitig anhaltender Aufmerksamkeit." },
                    { id: "KOG-3", name: "Kurzzeitged√§chtnis", beschreibung: "Zeigt Kurzzeitged√§chtnis durch Wiedererkennen von Personen oder Objekten." },
                    { id: "KOG-4", name: "Komplexe Reaktionen", beschreibung: "Reagiert auf komplexe Umgebungsreize und verbale Impulse mit motorischer Handlung." },
                    { id: "KOG-5", name: "Einfache Imitation", beschreibung: "Imitiert von sich aus einfache, vertraute Handlungen des Erwachsenen." },
                    { id: "KOG-6", name: "Motorik 18 Monate", beschreibung: "Zeigt rudiment√§re fein- und grobmotorische F√§higkeiten auf dem Niveau von 18 Monaten." },
                    { id: "KOG-7", name: "Bezeichnung", beschreibung: "L√§sst Verst√§ndnis von Bezeichnungen f√ºr vertraute Objekte erkennen." },
                    { id: "KOG-8", name: "Wort-Ann√§herung", beschreibung: "Reagiert verbal auf Fragen mit erkennbaren Wort-Ann√§herungen." },
                    { id: "KOG-9", name: "W√∂rter spontan", beschreibung: "Verwendet von sich aus erkennbare W√∂rter bei verschiedenen Aktivit√§ten." },
                    { id: "KOG-10", name: "Form", beschreibung: "Passt ein Objekt in eine daf√ºr passende L√ºcke ein." },
                    { id: "KOG-11", name: "K√∂rperteile", beschreibung: "Identifiziert eigene K√∂rperteile." },
                    { id: "KOG-12", name: "Details", beschreibung: "Erkennt einfache Details in Bildern." },
                    { id: "KOG-13", name: "Sortieren", beschreibung: "Ordnet zwei Sorten von Objekten einander zu." },
                    { id: "KOG-14", name: "Bilder benennen", beschreibung: "√Ñu√üert einzelne W√∂rter, um auf Abbildungen vertraute Dinge zu bezeichnen." }
                ]
            },
            {
                nummer: 2,
                stufenziel: "Erfolgreich auf die Umwelt reagieren",
                bereichsziel: "Beteiligung an Aktivit√§ten, die Selbsthilfe, motorische Koordination und Sprache erfordern",
                items: [
                    { id: "KOG-15", name: "Gebrauchswert", beschreibung: "Erkennt Gebrauchswert vertrauter Gegenst√§nde." },
                    { id: "KOG-16", name: "K√∂rper 3 Jahre", beschreibung: "F√ºhrt motorische Aktivit√§ten auf dem Niveau eines dreij√§hrigen Kindes aus." },
                    { id: "KOG-17", name: "Serie identisch", beschreibung: "Ordnet zwei identische Bilder einander zu." },
                    { id: "KOG-18", name: "Feinmotorik 3 Jahre", beschreibung: "F√ºhrt feinmotorische Aktivit√§ten auf dem Niveau eines dreij√§hrigen Kindes aus." },
                    { id: "KOG-19", name: "Serie anders", beschreibung: "Erkennt das Objekt, das sich von den anderen unterscheidet." },
                    { id: "KOG-20", name: "Gegenteile", beschreibung: "Versteht mindestens drei einfache Gegenteile." },
                    { id: "KOG-21", name: "Kategorisieren", beschreibung: "Gebraucht Kategorien beim Zuordnen einfacher Bilder." },
                    { id: "KOG-22", name: "Z√§hlen 4", beschreibung: "Z√§hlt bis 4 und wendet dabei 1 zu 1 Zuordnung an." },
                    { id: "KOG-23", name: "Farben", beschreibung: "Identifiziert vier Farben und drei Formen." },
                    { id: "KOG-24", name: "Alternation", beschreibung: "Gibt korrekte Antworten bei wechselnden Zuordnungsaufgaben." },
                    { id: "KOG-25", name: "Z√§hlen 10", beschreibung: "Z√§hlt mit 1 zu 1 Zuordnung bis 10." },
                    { id: "KOG-26", name: "Auge-Hand 5 Jahre", beschreibung: "F√ºhrt Aktivit√§ten aus, die Auge-Hand-Koordination auf 5-Jahres-Niveau erfordern." },
                    { id: "KOG-27", name: "Unterscheiden", beschreibung: "Unterscheidet zwischen Ziffern, Zeichen und Gro√übuchstaben." },
                    { id: "KOG-28", name: "K√∂rper 5 Jahre", beschreibung: "F√ºhrt motorische Aktivit√§ten auf dem Niveau eines f√ºnfj√§hrigen Kindes aus." },
                    { id: "KOG-29", name: "Objekte 5", beschreibung: "Erkennt die Anzahl von Objekten in einer Menge bis zu 5, ohne zu z√§hlen." },
                    { id: "KOG-30", name: "Ged√§chtnis", beschreibung: "Gibt Auswendiggelerntes wieder auf dem Niveau eines f√ºnfj√§hrigen Kindes." },
                    { id: "KOG-31", name: "Bilderserie", beschreibung: "Ordnet drei einfache Bilder in richtiger Reihenfolge an." }
                ]
            },
            {
                nummer: 3,
                stufenziel: "Erwerben von F√§higkeiten zur erfolgreichen Teilnahme in Gruppen",
                bereichsziel: "Beteiligt sich erfolgreich in einer Lerngruppe mit grundlegenden Lernkompetenzen",
                items: [
                    { id: "KOG-32", name: "Auge-Hand 6 Jahre", beschreibung: "F√ºhrt Aktivit√§ten aus, die Auge-Hand-Koordination auf 6-Jahres-Niveau erfordern." },
                    { id: "KOG-33", name: "K√∂rper 6 Jahre", beschreibung: "F√ºhrt motorische Aktivit√§ten auf dem Niveau eines sechsj√§hrigen Kindes aus." },
                    { id: "KOG-34", name: "Lesen 50", beschreibung: "Liest 50 W√∂rter des Grundwortschatzes." },
                    { id: "KOG-35", name: "Zahlen 10", beschreibung: "Erkennt und schreibt Zahlen, die Mengen bis 10 repr√§sentieren." },
                    { id: "KOG-36", name: "Schreiben 50", beschreibung: "Schreibt 50 W√∂rter des Grundwortschatzes nach Diktat." },
                    { id: "KOG-37", name: "Verst√§ndnis", beschreibung: "H√∂rt einer Geschichte zu und l√§sst Verst√§ndnis der Fakten erkennen." },
                    { id: "KOG-38", name: "Erkl√§ren", beschreibung: "Erkl√§rt das Verhalten anderer." },
                    { id: "KOG-39", name: "Sinnentnahme", beschreibung: "Liest einfache S√§tze und l√§sst dabei Verst√§ndnis des Inhalts erkennen." },
                    { id: "KOG-40", name: "Plus/Minus 9", beschreibung: "Beherrscht Addition und Subtraktion im Zahlenraum bis 9." },
                    { id: "KOG-41", name: "Unlogik", beschreibung: "Erkennt Unstimmigkeiten in einfachen Situationen." },
                    { id: "KOG-42", name: "Antworts√§tze", beschreibung: "Schreibt einfache S√§tze als Antworten auf Fragen." },
                    { id: "KOG-43", name: "Sport/Spiele", beschreibung: "Zeigt mindestens zwei motorische Kompetenzen auf Grundschulniveau." },
                    { id: "KOG-44", name: "S√§tze frei", beschreibung: "Formuliert und schreibt einfache S√§tze." },
                    { id: "KOG-45", name: "Numerische Konzepte", beschreibung: "Wendet grundlegende numerische Konzepte an (Addition, Subtraktion, Zeit, Geld)." },
                    { id: "KOG-46", name: "Quantitativa", beschreibung: "Liest und erkl√§rt quantitative Begriffe f√ºr Ma√üeinheiten." },
                    { id: "KOG-47", name: "Sachverhalte", beschreibung: "Liest kurze Geschichten und erz√§hlt von den Ereignissen." },
                    { id: "KOG-48", name: "Operationen", beschreibung: "F√ºhrt grundlegende Rechenoperationen durch (Stellenwert, √úbertrag, Multiplikation)." }
                ]
            },
            {
                nummer: 4,
                stufenziel: "Sich einbringen in Gruppenprozesse",
                bereichsziel: "Gebraucht kognitive und schulische F√§higkeiten f√ºr soziale Gruppenerfahrungen",
                items: [
                    { id: "KOG-49", name: "Kommunikation", beschreibung: "Schreibt, um Informationen, Ereignisse oder Gef√ºhle mitzuteilen." },
                    { id: "KOG-50", name: "Mult./Divis. 100", beschreibung: "Rechnet Multiplikations- und Divisionsaufgaben im Zahlenraum bis 100." },
                    { id: "KOG-51", name: "Informationsgewinn", beschreibung: "Liest aus Freude am Lesen und zum pers√∂nlichen Informationsgewinn." },
                    { id: "KOG-52", name: "Geldmenge 10‚Ç¨", beschreibung: "Berechnet Wert f√ºr Geldmengen bis zu 10 Euro." },
                    { id: "KOG-53", name: "Fiktion", beschreibung: "Beschreibt fiktive Charaktere und erkl√§rt deren Motive." },
                    { id: "KOG-54", name: "Grammatik", beschreibung: "Verwendet grammatische Regeln beim Schreiben." },
                    { id: "KOG-55", name: "Wertvorstellungen", beschreibung: "Erkennt und unterscheidet gegens√§tzliche Werte in sozialen Situationen." },
                    { id: "KOG-56", name: "Konzepte", beschreibung: "Gebraucht Ma√üeinheiten, um einfache logische Probleme zu l√∂sen." }
                ]
            },
            {
                nummer: 5,
                stufenziel: "Anwenden von F√§higkeiten in neuen Situationen",
                bereichsziel: "Setzt erfolgreich kognitive F√§higkeiten zur Bereicherung pers√∂nlicher Erfahrungen ein",
                items: [
                    { id: "KOG-57", name: "Zeitgeschichte", beschreibung: "Sucht die Meinung anderer zu aktuellen Problemen zu erfahren." },
                    { id: "KOG-58", name: "Meinungen", beschreibung: "Unterscheidet in Texten zwischen Fakten und Meinungen." },
                    { id: "KOG-59", name: "Inkonsistenz", beschreibung: "Erkennt unlogisches und unstimmiges Verhalten bei anderen." },
                    { id: "KOG-60", name: "Textaufgaben", beschreibung: "L√∂st Textaufgaben mit Bruchrechnung, Dezimalrechnung und negativen Zahlen." },
                    { id: "KOG-61", name: "Einsicht", beschreibung: "L√∂st pers√∂nliche Probleme anhand von Einsicht, Analyse und Generalisierung." },
                    { id: "KOG-62", name: "B√ºrger/in", beschreibung: "Gebraucht selbst√§ndig kognitive Verfahren in der Rolle als B√ºrger/in und Arbeitnehmer/in." }
                ]
            }
        ]
    }
};

// ==========================================
// State
// ==========================================
const assessments = {};
let currentDomain = 'verhalten';

// Initialize assessments
Object.keys(ELDIB_DATA).forEach(domain => {
    assessments[domain] = {};
    ELDIB_DATA[domain].stufen.forEach(stufe => {
        stufe.items.forEach(item => {
            assessments[domain][item.id] = { erreicht: false, ziel: false };
        });
    });
});

// ==========================================
// Render Functions
// ==========================================
function renderDomain(domain) {
    const data = ELDIB_DATA[domain];
    let html = '';

    data.stufen.forEach(stufe => {
        const allReached = isStufeComplete(domain, stufe.nummer);
        html += `
            <div class="stufe-container" data-domain="${domain}">
                <div class="stufe-header">
                    <div class="stufe-header-text">
                        <h3>Stufe ${stufe.nummer}: ${stufe.stufenziel}</h3>
                        <p>${stufe.bereichsziel}</p>
                    </div>
                    <button class="stufe-complete-btn ${allReached ? 'completed' : ''}"
                            onclick="toggleStufeComplete('${domain}', ${stufe.nummer})">
                        ${allReached ? '‚úì Stufe erreicht' : '‚òê Stufe komplett erreicht'}
                    </button>
                </div>
                <div class="items-list">
                    ${stufe.items.map(item => renderItem(domain, item, stufe.nummer)).join('')}
                </div>
            </div>
        `;
    });

    return html;
}

function isStufeComplete(domain, stufeNummer) {
    const data = ELDIB_DATA[domain];
    const stufe = data.stufen.find(s => s.nummer === stufeNummer);
    if (!stufe) return false;
    return stufe.items.every(item => assessments[domain][item.id].erreicht);
}

function toggleStufeComplete(domain, stufeNummer) {
    const data = ELDIB_DATA[domain];
    const stufe = data.stufen.find(s => s.nummer === stufeNummer);
    if (!stufe) return;

    const allReached = isStufeComplete(domain, stufeNummer);

    // Toggle: if all reached, uncheck all; otherwise check all
    stufe.items.forEach(item => {
        assessments[domain][item.id].erreicht = !allReached;
        if (!allReached) {
            assessments[domain][item.id].ziel = false;
        }
    });

    renderAllDomains();
    updateStats();
    saveToLocalStorage();
}

function renderItem(domain, item, stufeNummer) {
    const status = assessments[domain][item.id];

    // Pr√ºfe ob Ziele blockiert werden sollen
    const zielDisabled = status.nichtErreicht || isZielDisabledByBioAge(domain, stufeNummer);
    const zielDisabledClass = zielDisabled ? 'checkbox-disabled' : '';
    const zielGroupDisabled = zielDisabled ? 'disabled' : '';

    return `
        <div class="item-row" data-domain="${domain}" data-item-id="${item.id}">
            <div class="item-info" ondblclick="showItemModal('${domain}', '${item.id}')">
                <span class="item-code">${item.id}</span>
                <span class="item-name">${item.name}</span>
                <div class="item-description">${item.beschreibung}</div>
            </div>
            <div class="item-checkboxes">
                <div class="checkbox-group">
                    <label>Erreicht</label>
                    <div class="checkbox-erreicht ${status.erreicht ? 'checked' : ''}"
                         onclick="toggleStatus('${domain}', '${item.id}', 'erreicht')"></div>
                </div>
                <div class="checkbox-group">
                    <label>Nicht err.</label>
                    <div class="checkbox-nicht-erreicht ${status.nichtErreicht ? 'checked' : ''}"
                         onclick="toggleStatus('${domain}', '${item.id}', 'nichtErreicht')"></div>
                </div>
                <div class="checkbox-group ${zielGroupDisabled}">
                    <label>Ziel</label>
                    <div class="checkbox-ziel ${status.ziel ? 'checked' : ''} ${zielDisabledClass}"
                         onclick="${zielDisabled ? '' : "toggleStatus('" + domain + "', '" + item.id + "', 'ziel')"}"></div>
                </div>
            </div>
        </div>
    `;
}

// Pr√ºft ob Ziele f√ºr diese Stufe blockiert sind (weil Bio-Alter >= Stufen-Alter)
function isZielDisabledByBioAge(domain, stufeNummer) {
    const birthDate = document.getElementById('birthDate')?.value;
    if (!birthDate) return false;

    const bioAgeDecimal = parseFloat(calculateAge(birthDate));
    if (isNaN(bioAgeDecimal) || bioAgeDecimal <= 0) return false;

    // Stufen-Altersreferenzen
    const stufenAlter = {
        1: 2,   // 0-2 Jahre
        2: 5,   // 2-5 Jahre
        3: 9,   // 6-9 Jahre
        4: 12,  // 10-12 Jahre
        5: 16   // 13-16 Jahre
    };

    const stufeMaxAge = stufenAlter[stufeNummer] || 16;

    // Wenn Bio-Alter >= Stufen-Maximum, dann keine Ziele mehr erlaubt (nur Ressourcen)
    return bioAgeDecimal >= stufeMaxAge;
}

// Modal f√ºr Item-Details anzeigen
function showItemModal(domain, itemId) {
    const data = ELDIB_DATA[domain];
    let item = null;

    for (const stufe of data.stufen) {
        item = stufe.items.find(i => i.id === itemId);
        if (item) break;
    }

    if (!item) return;

    document.getElementById('modalItemCode').textContent = item.id;
    document.getElementById('modalItemCode').style.background = data.color;
    document.getElementById('modalItemTitle').textContent = item.name;
    document.getElementById('modalItemDescription').textContent = item.beschreibung;
    document.getElementById('itemModal').classList.add('active');

    // ESC-Taste zum Schlie√üen
    document.addEventListener('keydown', handleModalEsc);
}

function handleModalEsc(e) {
    if (e.key === 'Escape') closeItemModal();
}

function closeItemModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('itemModal').classList.remove('active');
    document.removeEventListener('keydown', handleModalEsc);
}

function renderAllDomains() {
    const container = document.getElementById('domainContent');
    let html = '';

    Object.keys(ELDIB_DATA).forEach(domain => {
        html += `<div class="domain-section ${domain === currentDomain ? 'active' : ''}" data-domain="${domain}">
            ${renderDomain(domain)}
        </div>`;
    });

    container.innerHTML = html;
}

// ==========================================
// Event Handlers
// ==========================================
function switchDomain(domain) {
    currentDomain = domain;

    // Update tabs
    document.querySelectorAll('.domain-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.domain === domain);
    });

    // Update sections
    document.querySelectorAll('.domain-section').forEach(section => {
        section.classList.toggle('active', section.dataset.domain === domain);
    });

    // Vergleichs-Sektion
    const compSection = document.getElementById('comparisonSection');
    const mainContent = document.querySelector('.main-content');

    if (domain === 'vergleich') {
        compSection.classList.add('active');
        mainContent.style.display = 'none';
        renderComparison();
    } else {
        compSection.classList.remove('active');
        mainContent.style.display = 'block';
    }
}

function toggleStatus(domain, itemId, type) {
    const item = assessments[domain][itemId];

    switch (type) {
        case 'erreicht':
            item.erreicht = !item.erreicht;
            if (item.erreicht) {
                // Erreicht schlie√üt nichtErreicht und ziel aus
                item.nichtErreicht = false;
                item.ziel = false;
            }
            break;

        case 'nichtErreicht':
            item.nichtErreicht = !item.nichtErreicht;
            if (item.nichtErreicht) {
                // Nicht erreicht schlie√üt erreicht aus, ziel wird automatisch deaktiviert
                item.erreicht = false;
                item.ziel = false;
            }
            break;

        case 'ziel':
            item.ziel = !item.ziel;
            if (item.ziel) {
                // Ziel schlie√üt erreicht und nichtErreicht aus
                item.erreicht = false;
                item.nichtErreicht = false;
            }
            break;
    }

    renderAllDomains();
    updateStats();
    saveToLocalStorage();
}

function updateStats() {
    let totalErreicht = 0;
    let totalZiele = 0;

    Object.keys(assessments).forEach(domain => {
        Object.values(assessments[domain]).forEach(status => {
            if (status.erreicht) totalErreicht++;
            if (status.ziel) totalZiele++;
        });
    });

    document.getElementById('totalErreicht').textContent = totalErreicht;
    document.getElementById('totalZiele').textContent = totalZiele;
}

// ==========================================
// Local Storage
// ==========================================
function saveToLocalStorage() {
    // Alte Speichermethode f√ºr Kompatibilit√§t
    const data = {
        assessments: assessments,
        student: getStudentData()
    };
    localStorage.setItem('eldib_data_v2', JSON.stringify(data));

    // Neue Speichermethode: Aktuelle Evaluation speichern
    saveCurrentEvaluation();
}

function loadFromLocalStorage() {
    const saved = localStorage.getItem('eldib_data_v2');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            if (data.assessments) {
                Object.keys(data.assessments).forEach(domain => {
                    if (assessments[domain]) {
                        Object.assign(assessments[domain], data.assessments[domain]);
                    }
                });
            }
            if (data.student) {
                document.getElementById('studentName').value = data.student.name || '';
                document.getElementById('birthDate').value = data.student.birthDate || '';
                document.getElementById('foerderort').value = data.student.foerderort || '';
                document.getElementById('assessmentDate').value = data.student.assessmentDate || '';
                document.getElementById('assessorName').value = data.student.assessorName || '';
            }
        } catch (e) {
            console.error('Error loading saved data:', e);
        }
    }
}

function getStudentData() {
    return {
        name: document.getElementById('studentName').value,
        birthDate: document.getElementById('birthDate').value,
        foerderort: document.getElementById('foerderort').value,
        assessmentDate: document.getElementById('assessmentDate').value,
        assessorName: document.getElementById('assessorName').value
    };
}

// ==========================================
// Word Export (HTML-basiert, keine externen Bibliotheken n√∂tig)
// ==========================================

// Entwicklungsstufen-Mapping
const STAGE_DATA = {
    1: { ageMin: 0, ageMax: 2, ageMid: 1, label: "0-2 Jahre", angst: "Verlassenheit", beschreibung: "Grundlegendes Vertrauen aufbauen" },
    2: { ageMin: 2, ageMax: 5, ageMid: 3.5, label: "2-5 Jahre", angst: "Unzul√§nglichkeit", beschreibung: "Autonomie und Selbstwirksamkeit entwickeln" },
    3: { ageMin: 6, ageMax: 9, ageMid: 7.5, label: "6-9 Jahre", angst: "Schuld", beschreibung: "Initiative und Kompetenz erwerben" },
    4: { ageMin: 10, ageMax: 12, ageMid: 11, label: "10-12 Jahre", angst: "Konflikt", beschreibung: "Soziale Rollen und Beziehungen gestalten" },
    5: { ageMin: 13, ageMax: 16, ageMid: 14.5, label: "13-16 Jahre", angst: "Identit√§t", beschreibung: "Identit√§t und Werte entwickeln" }
};

// Interventions-Datenbank aus ELDiB-Dokumenten
const INTERVENTIONS_DATA = {
    // VERHALTEN
    "V-1": {
        zielformulierung: "Ich schaue den/die LehrerIn an, wenn sie/er mich ber√ºhrt.",
        interventionen: ["Aktivierung des Ziels durch direkten Kontakt", "Spiegeln der Reaktionen des Kindes", "Sensorische Reize gezielt einsetzen"]
    },
    "V-2": {
        zielformulierung: "Ich schaue mir Bilder an, die die Lehrerin/der Lehrer mir zeigt.",
        interventionen: ["Geschichte vorlesen und Bilder zeigen", "Sensomotorische Aktivit√§ten anbieten", "Interaktive Spiele mit verschiedenen Texturen"]
    },
    "V-3": {
        zielformulierung: "Ich schaue auf das, was mir vorgezeigt wird.",
        interventionen: ["Aufmerksamkeit auf kurze Erkl√§rungsphasen lenken", "Mit visuellen Verst√§rkungssignalen arbeiten (Piktogramme)", "Kurze, pr√§gnante Reize verwenden"]
    },
    "V-4": {
        zielformulierung: "Wenn der/die LehrerIn mir die Hand reicht, nehme ich sie.",
        interventionen: ["Verhaltensanweisungen gezielt und direkt formulieren", "Konzentration durch spielerische Anreize f√∂rdern", "Individuelle Verhaltensanweisungen ausarbeiten"]
    },
    "V-5": {
        zielformulierung: "Ich baue einen Turm, wenn ich Baukl√∂tze angeboten bekomme.",
        interventionen: ["Gezielte Aktivit√§ten mit klaren Anweisungen anbieten", "Rollenspiele und praktische √úbungen", "Strukturierung der Umgebung"]
    },
    "V-6": {
        zielformulierung: "Morgens h√§nge ich meine Jacke an den Haken.",
        interventionen: ["Routineabl√§ufe garantieren und institutionalisieren", "Piktogramme einsetzen", "Lernen am Modell erm√∂glichen"]
    },
    "V-7": {
        zielformulierung: "Ich r√§ume die B√ºcher in das Regal wenn die/der LehrerIn das sagt.",
        interventionen: ["Verhaltensanforderung klar benennen", "Aufr√§umaktivit√§ten zur Zielerreichung nutzen", "Vielf√§ltige Spielmaterialien anbieten"]
    },
    "V-8": {
        zielformulierung: "Wenn der Lehrer/die Lehrerin sagt, dass wir in die Pause gehen, r√§ume ich mein Pult.",
        interventionen: ["Visualisierung durch Stundenablauf", "Klar definierte Aktivit√§tenbereiche", "Rituale und Routineabl√§ufe garantieren"]
    },
    "V-9": {
        zielformulierung: "In der Pause benutze ich den Fu√üball auf dem Fu√üballfeld.",
        interventionen: ["Klare Spielregeln definieren", "Spiegeln bei angepasstem Verhalten", "Kontrolle des Materials durch den Erwachsenen"]
    },
    "V-10": {
        zielformulierung: "Ich warte bis der/die LehrerIn mich mit meinem Namen ruft.",
        interventionen: ["Wartezeit konkretisieren mit Time Timer oder Sanduhr", "Physische N√§he bieten", "Vorhersehbare Routine einf√ºhren"]
    },
    "V-11": {
        zielformulierung: "Ich bleibe w√§hrend der Matheaufgabe sitzen.",
        interventionen: ["Zeitliche Struktur mit Time Timer festsetzen", "Interessante Aktivit√§ten anbieten", "Bewegungspausen einplanen"]
    },
    "V-12": {
        zielformulierung: "Ich beteilige mich w√§hrend des Sportunterrichts.",
        interventionen: ["Wiederkehrenden Ablauf etablieren", "Piktogramme zur Visualisierung", "Ansprechende Bewegungspausen anbieten"]
    },
    "V-13": {
        zielformulierung: "Ich setze mich in den Morgenkreis, wenn der Tag beginnt.",
        interventionen: ["Zieleinf√ºhrung und Aktivierung des Ziels", "Tagesablauf strukturieren", "Interessen des Kindes ber√ºcksichtigen"]
    },
    "V-14": {
        zielformulierung: "Ich nehme Lob von anderen an und behalte die Kontrolle.",
        interventionen: ["Selbstwertgef√ºhl st√§rken", "Spezifische Lobsituationen initiieren (Rollenspiele)", "Ritual 'Siegerfaust' initiieren"]
    },
    "V-15": {
        zielformulierung: "Wenn ich eine Aufgabe verstanden habe, l√∂se ich sie alleine.",
        interventionen: ["Zeit ank√ºndigen mit Time Timer", "Strukturierung der Aufgaben anpassen", "Kleine Erfolgserlebnisse sichern"]
    },
    "V-16": {
        zielformulierung: "Wenn mich jemand fragt, sage ich, was unsere Ziele in der Klasse sind.",
        interventionen: ["Visualisieren der Ziele", "Ziele zu fest gelegten Zeiten aktivieren und ein√ºben", "Klare Erkl√§rungen geben"]
    },
    "V-17": {
        zielformulierung: "Wenn ich gefragt werde, kann ich sagen warum ein bestimmtes Verhalten erwartet wird.",
        interventionen: ["Im Klassenrat Verhalten und Folgen reflektieren", "Regelnotwendigkeit an Situationen erarbeiten", "Kognitive R√ºckschau durchf√ºhren"]
    },
    "V-18": {
        zielformulierung: "Ich sage wie ich mich anders und angemessen verhalten k√∂nnte.",
        interventionen: ["Konfliktgespr√§che initiieren", "Alternative Verhaltensweisen erarbeiten", "Rollenspiele zu sozialen Situationen"]
    },
    // KOMMUNIKATION
    "K-1": {
        zielformulierung: "Ich produziere verschiedene Laute um mich auszudr√ºcken.",
        interventionen: ["Logop√§dische Unterst√ºtzung einschalten", "Lautmuster wiederholen und best√§rken", "Musikalische Aktivit√§ten anbieten"]
    },
    "K-2": {
        zielformulierung: "Ich schaue die Person an, die spricht.",
        interventionen: ["Blickkontakt herstellen", "Interessante Stimme und Gestik einsetzen", "Kurze und klare Kommunikation"]
    },
    "K-4": {
        zielformulierung: "Wenn ich etwas gefragt werde, antworte ich.",
        interventionen: ["Einfache Sprache verwenden", "Unterst√ºtzende Umgebung schaffen", "Fragen in Spiele integrieren"]
    },
    "K-5": {
        zielformulierung: "Wenn der/die LehrerIn mir etwas zeigt und fragt was es ist, antworte ich.",
        interventionen: ["Lernen am Modell", "Offene Fragen stellen", "Vokabular spielerisch erweitern"]
    },
    "K-6": {
        zielformulierung: "Ich spreche mit dem/der LehrerIn, wenn ich etwas m√∂chte.",
        interventionen: ["Piktogramme benutzen", "Relevante Situationen schaffen", "Objekte benennen zur Vokabelerarbeitung"]
    },
    "K-7": {
        zielformulierung: "Ich spreche mit dem anderen Kind, wenn ich etwas m√∂chte.",
        interventionen: ["Rollenspiel mit minimalem Vokabular", "Einfache Kooperationsspiele anbieten", "Visualisierung des Zieles durch Piktogramm"]
    },
    "K-8": {
        zielformulierung: "Wenn ich etwas sagen will, mache ich einen ganzen Satz.",
        interventionen: ["Wiederholung des ganzen Satzes", "Spielerisches Erlernen vom Satzbau", "Positive Verst√§rkung durch Spiegeln"]
    },
    "K-9": {
        zielformulierung: "Ich antworte auf die Frage, die mir gestellt wird, so dass jeder meine Antwort verstehen kann.",
        interventionen: ["Adaptierte Fragen gezielt stellen", "Kooperationsspiele anbieten", "Kleingruppenarbeit erm√∂glichen"]
    },
    "K-11": {
        zielformulierung: "Ich spreche freundlich, wenn ich etwas haben m√∂chte.",
        interventionen: ["Ein√ºben von freundlichem Sprechen (Rollenspiel)", "Giraffensprache einf√ºhren", "Ad√§quate Kontaktaufnahme ein√ºben"]
    },
    "K-15": {
        zielformulierung: "Ich erz√§hle von Dingen, die ich erlebt habe.",
        interventionen: ["Morgenkreis und Erz√§hlkreis nutzen", "Klassenrat f√ºr Austausch", "Gruppenaktivit√§ten die Austausch erfordern"]
    },
    "K-16": {
        zielformulierung: "Wenn ich w√ºtend bin, sage ich, was mich st√∂rt, ohne jemanden zu verletzen.",
        interventionen: ["Gef√ºhlsbarometer einf√ºhren", "Methoden zum Gef√ºhle-Mitteilen erlernen", "Material zur Stressbew√§ltigung anbieten"]
    },
    "K-17": {
        zielformulierung: "Bei Besprechungen in der Gruppe sage ich ruhig und freundlich meine Meinung.",
        interventionen: ["Verhaltensanforderungen klar formulieren", "Klassenrat nutzen", "Gespr√§chsregeln visualisieren"]
    },
    // SOZIALISATION
    "SOZ-1": {
        zielformulierung: "Ich nehme wahr, wenn andere Kinder in meiner N√§he sind.",
        interventionen: ["Gemeinsame Aktivit√§ten in Kleingruppen", "Physische N√§he zu anderen erm√∂glichen", "Parallelspiel f√∂rdern"]
    },
    "SOZ-4": {
        zielformulierung: "Ich besch√§ftige mich selbstst√§ndig mit Spielmaterialien.",
        interventionen: ["Strukturierte Spielzeit anbieten", "Interessantes Material bereitstellen", "Sichere Spielumgebung schaffen"]
    },
    "SOZ-10": {
        zielformulierung: "Ich spiele neben anderen Kindern.",
        interventionen: ["Parallelspiel-Situationen schaffen", "Gemeinsame Spielbereiche einrichten", "Positives Verhalten spiegeln"]
    },
    "SOZ-14": {
        zielformulierung: "Ich warte ohne k√∂rperliche Steuerungshilfe.",
        interventionen: ["Time Timer oder Sanduhr verwenden", "Physische N√§he bieten", "Konkrete Verhaltensanweisungen geben"]
    },
    "SOZ-15": {
        zielformulierung: "Ich zeige Ans√§tze, Kontakt zu einem anderen Kind aufzunehmen.",
        interventionen: ["Kooperative Spiele initiieren", "Soziale Skripts √ºben", "Positive Interaktionen verst√§rken"]
    },
    "SOZ-17": {
        zielformulierung: "Ich beteilige mich erfolgreich an interaktivem Spiel mit einem anderen Kind.",
        interventionen: ["Strukturierte Spielsituationen schaffen", "Spielregeln klar kommunizieren", "Erwachsene als Spielbegleiter einsetzen"]
    },
    "SOZ-19": {
        zielformulierung: "Ich teile von mir aus Materialien und wechsle mich mit anderen ab.",
        interventionen: ["Teilen explizit √ºben", "Positive Verst√§rkung beim Teilen", "Abwechseln in Spielen thematisieren"]
    },
    "SOZ-25": {
        zielformulierung: "Ich zeige beginnende Freundschaft durch Vorliebe f√ºr ein bestimmtes Kind.",
        interventionen: ["Gemeinsame Aktivit√§ten mit bevorzugtem Kind", "Freundschaftliche Interaktionen f√∂rdern", "√úber Freundschaft sprechen"]
    },
    // KOGNITION
    "KOG-1": {
        zielformulierung: "Ich reagiere auf Reize mit Zuwendung zur Reizquelle.",
        interventionen: ["Sensorische Aktivit√§ten anbieten", "Visuelle und auditive Reize einsetzen", "Aufmerksamkeit gezielt lenken"]
    },
    "KOG-3": {
        zielformulierung: "Ich erkenne Personen oder Objekte wieder.",
        interventionen: ["Memory-Spiele einsetzen", "Bekannte Objekte benennen", "Wiedererkennungsspiele spielen"]
    },
    "KOG-10": {
        zielformulierung: "Ich passe ein Objekt in eine passende L√ºcke ein.",
        interventionen: ["Form-Sortierspiele anbieten", "Puzzles in steigender Schwierigkeit", "Hands-on Materialien verwenden"]
    },
    "KOG-15": {
        zielformulierung: "Ich erkenne den Gebrauchswert vertrauter Gegenst√§nde.",
        interventionen: ["Alltagsgegenst√§nde erkunden", "Funktionen spielerisch erarbeiten", "So-tun-als-ob-Spiele"]
    },
    "KOG-22": {
        zielformulierung: "Ich z√§hle bis 4 und wende dabei 1-zu-1 Zuordnung an.",
        interventionen: ["Z√§hlspiele mit konkretem Material", "Mengen visuell darstellen", "Allt√§gliche Z√§hlsituationen nutzen"]
    },
    "KOG-34": {
        zielformulierung: "Ich lese 50 W√∂rter des Grundwortschatzes.",
        interventionen: ["T√§gliche Lese√ºbungen", "Wort-Bild-Zuordnungen", "Lesespiele und -apps einsetzen"]
    }
};

// Fallback f√ºr Items ohne spezifische Intervention
function getInterventionData(itemId) {
    if (INTERVENTIONS_DATA[itemId]) {
        return INTERVENTIONS_DATA[itemId];
    }
    // Generische Intervention basierend auf Bereich
    const prefix = itemId.split('-')[0];
    const genericInterventions = {
        'V': {
            zielformulierung: "Ich zeige das erwartete Verhalten in der beschriebenen Situation.",
            interventionen: ["Verhaltensanforderung klar benennen und aktivieren", "Positives Verhalten spiegeln", "Strukturierte √úbungssituationen schaffen"]
        },
        'K': {
            zielformulierung: "Ich dr√ºcke mich angemessen aus.",
            interventionen: ["Sprachliche Modelle anbieten", "Kommunikationssituationen schaffen", "Positive Verst√§rkung bei Kommunikation"]
        },
        'SOZ': {
            zielformulierung: "Ich verhalte mich sozial angemessen in der Gruppe.",
            interventionen: ["Soziale Situationen √ºben", "Kooperative Spiele anbieten", "Positive Interaktionen verst√§rken"]
        },
        'KOG': {
            zielformulierung: "Ich bew√§ltige die kognitive Anforderung.",
            interventionen: ["Aufgaben in kleine Schritte unterteilen", "Konkretes Material verwenden", "Wiederholung und √úbung sicherstellen"]
        }
    };
    return genericInterventions[prefix] || genericInterventions['V'];
}

function calculateAge(birthDate) {
    if (!birthDate) return null;
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
    }
    // Also calculate months for more precision
    let months = today.getMonth() - birth.getMonth();
    if (today.getDate() < birth.getDate()) months--;
    if (months < 0) months += 12;
    return { years: age, months: months, decimal: age + (months / 12) };
}

// Generiert individuelle professionelle Statements pro Bereich mit Implikationen
function generateDomainStatement(domain, domainName, bioAge, devAge, gap, stage, angst, domainStageData) {
    if (gap === null || !bioAge || !devAge) {
        return `Keine vollst√§ndige Einsch√§tzung im Bereich ${domainName} m√∂glich.`;
    }

    // Globale Implikationen: Was bedeutet dieser Entwicklungsstand konkret?
    const implications = {
        verhalten: {
            1: {
                alltag: "Das Kind braucht st√§ndige Begleitung und reagiert impulsiv auf Reize. √úberg√§nge und Ver√§nderungen l√∂sen starke Reaktionen aus.",
                schwierigkeit: "Selbstst√§ndige Teilnahme an Gruppenaktivit√§ten ist nicht m√∂glich. Jeder Handlungsschritt braucht direkte Anleitung.",
                peers: "W√§hrend Gleichaltrige selbstst√§ndig Routinen folgen, ben√∂tigt dieses Kind 1:1-Begleitung wie ein Kleinkind."
            },
            2: {
                alltag: "Das Kind kann kurz warten und an Aktivit√§ten teilnehmen, verliert aber bei Frustration schnell die Kontrolle.",
                schwierigkeit: "Gruppensituationen ohne enge Begleitung f√ºhren zu Konflikten. Regeln werden noch nicht als sinnvoll verstanden.",
                peers: "Gleichaltrige zeigen bereits Frustrationstoleranz - dieses Kind reagiert auf Entt√§uschungen noch wie ein Kleinkind."
            },
            3: {
                alltag: "Das Kind kennt Regeln und verh√§lt sich in strukturierten Situationen angemessen, braucht aber Erinnerungen und Unterst√ºtzung.",
                schwierigkeit: "Bei unerwarteten Situationen oder wenn andere die Kontrolle verlieren, destabilisiert sich das Kind.",
                peers: "Im Vergleich zu Gleichaltrigen fehlt die F√§higkeit, Verhalten flexibel an neue Situationen anzupassen."
            },
            4: {
                alltag: "Das Kind kann sein Verhalten reflektieren und Alternativen benennen, setzt diese unter Stress aber nicht immer um.",
                schwierigkeit: "Eigenverantwortung und Selbststeuerung in komplexen Situationen fallen noch schwer.",
                peers: "Gleichaltrige √ºbernehmen bereits Verantwortung f√ºr Gruppenentscheidungen."
            },
            5: {
                alltag: "Das Kind zeigt reife Verhaltenssteuerung und reagiert auch in neuen Situationen angemessen.",
                schwierigkeit: "Unter extremem Druck k√∂nnen fr√ºhere Muster auftreten.",
                peers: "Das Verhalten entspricht dem der Gleichaltrigen."
            }
        },
        kommunikation: {
            1: {
                alltag: "Kommunikation erfolgt haupts√§chlich nonverbal oder mit einzelnen W√∂rtern. Bed√ºrfnisse werden durch Verhalten ausgedr√ºckt.",
                schwierigkeit: "Frustration durch mangelnde Ausdrucksm√∂glichkeit f√ºhrt zu Verhaltensauff√§lligkeiten. Anweisungen werden oft nicht verstanden.",
                peers: "W√§hrend Gleichaltrige komplexe Gespr√§che f√ºhren, kommuniziert dieses Kind auf Kleinkind-Niveau."
            },
            2: {
                alltag: "Einfache S√§tze werden verwendet, komplexe Gedanken k√∂nnen aber nicht verbalisiert werden.",
                schwierigkeit: "Missverst√§ndnisse sind h√§ufig. Konflikte k√∂nnen nicht verbal gel√∂st werden - das Kind greift auf Handlungen zur√ºck.",
                peers: "Gleichaltrige diskutieren und argumentieren - dieses Kind kann nur einfache Aussagen machen."
            },
            3: {
                alltag: "Das Kind berichtet √ºber Erlebnisse und benennt Gef√ºhle, hat aber Schwierigkeiten mit abstrakten Themen.",
                schwierigkeit: "Schulische Anforderungen an Leseverst√§ndnis und Ausdruck √ºberfordern das Kind oft.",
                peers: "Gespr√§che mit Gleichaltrigen scheitern manchmal am unterschiedlichen Sprachniveau."
            },
            4: {
                alltag: "Gef√ºhle werden reflektiert und Beziehungen sprachlich gestaltet, komplexe Themen brauchen Unterst√ºtzung.",
                schwierigkeit: "Abstrakte Unterrichtsinhalte und differenzierte Diskussionen sind herausfordernd.",
                peers: "Kommunikation gelingt, tiefere Gespr√§che √ºber Werte oder Zukunft fallen schwer."
            },
            5: {
                alltag: "Differenzierte Kommunikation und sprachliche Beziehungspflege sind m√∂glich.",
                schwierigkeit: "Sehr abstrakte oder emotionale Themen k√∂nnen gelegentlich schwierig sein.",
                peers: "Kommunikationsf√§higkeit entspricht der Altersgruppe."
            }
        },
        sozialisation: {
            1: {
                alltag: "Das Kind spielt allein oder parallel, zeigt wenig Interesse an Peers. Bindung zu Erwachsenen steht im Vordergrund.",
                schwierigkeit: "Gruppenaktivit√§ten sind kaum m√∂glich. Das Kind sucht st√§ndig die N√§he vertrauter Erwachsener.",
                peers: "Gleichaltrige bilden Freundschaften und spielen kooperativ - dieses Kind ist noch im Parallelspiel."
            },
            2: {
                alltag: "Kurzes gemeinsames Spiel ist m√∂glich, Teilen und Abwechseln f√ºhren aber oft zu Konflikten.",
                schwierigkeit: "Stabile Freundschaften entstehen nicht. Das Kind wird oft ausgeschlossen wegen unreifen Sozialverhaltens.",
                peers: "W√§hrend Gleichaltrige feste Freundschaften haben, wechselt dieses Kind h√§ufig Spielpartner."
            },
            3: {
                alltag: "Beginnende Freundschaften und Befolgen von Gruppenregeln, aber Konflikte brauchen Unterst√ºtzung.",
                schwierigkeit: "Komplexe soziale Dynamiken wie Cliquen oder subtile Ausgrenzung werden nicht verstanden.",
                peers: "Gleichaltrige navigieren komplexe Situationen - dieses Kind versteht nur einfache Gruppenstrukturen."
            },
            4: {
                alltag: "Aktive Beteiligung in Gruppen und Ber√ºcksichtigung verschiedener Perspektiven.",
                schwierigkeit: "Tiefere Freundschaften mit gegenseitiger Unterst√ºtzung entwickeln sich noch.",
                peers: "Soziale F√§higkeiten n√§hern sich dem Niveau Gleichaltriger an."
            },
            5: {
                alltag: "Tragf√§hige Beziehungen und echte Empathie sind vorhanden.",
                schwierigkeit: "Komplexe Situationen wie romantische Beziehungen k√∂nnen herausfordernd sein.",
                peers: "Soziale Kompetenz entspricht der Altersgruppe."
            }
        },
        kognition: {
            1: {
                alltag: "Lernen erfolgt durch Sinneserfahrung und Wiederholung. Abstraktes Denken ist nicht m√∂glich.",
                schwierigkeit: "Schulische Anforderungen k√∂nnen nicht erf√ºllt werden. Jeder Lernschritt braucht konkretes Material.",
                peers: "Gleichaltrige arbeiten mit Texten und Zahlen - dieses Kind braucht Bildmaterial und Handlungsorientierung."
            },
            2: {
                alltag: "Sortieren, Z√§hlen und einfache Muster werden erkannt, Lesen und Schreiben sind noch nicht m√∂glich.",
                schwierigkeit: "Der Regellehrplan ist nicht zug√§nglich. Adaptiertes Material auf Vorschulniveau wird ben√∂tigt.",
                peers: "W√§hrend Gleichaltrige lesen und rechnen, arbeitet dieses Kind mit Vorschulmaterial."
            },
            3: {
                alltag: "Grundlegende Kulturtechniken sind vorhanden, schulische Anforderungen entsprechen j√ºngerem Alter.",
                schwierigkeit: "Komplexere Aufgaben, Textaufgaben und abstraktes Denken √ºberfordern.",
                peers: "Der Leistungsunterschied zu Gleichaltrigen wird in h√∂heren Klassen deutlicher."
            },
            4: {
                alltag: "Wissen wird angewendet und einfache Probleme werden gel√∂st.",
                schwierigkeit: "Abstrakte Konzepte erfordern zus√§tzliche Erkl√§rung.",
                peers: "Kognitive F√§higkeiten n√§hern sich dem Niveau Gleichaltriger an."
            },
            5: {
                alltag: "Differenziertes Denken und Problemanalyse sind m√∂glich.",
                schwierigkeit: "Sehr komplexe Problemstellungen k√∂nnen Unterst√ºtzung erfordern.",
                peers: "Kognitive Kompetenz entspricht der Altersgruppe."
            }
        }
    };

    const impl = implications[domain]?.[stage] || implications.verhalten[1];
    const stufenLabel = STAGE_DATA[stage]?.label || "0-2 Jahre";

    // Altersgem√§√ü
    if (gap <= 0) {
        return `<strong>${domainName} ‚Äì Altersgem√§√ü (Stufe ${stage}):</strong> ${impl.alltag} Diese Kompetenz ist eine wichtige Ressource.`;
    }

    // Mit Entwicklungsdifferenz
    return `<strong>${domainName} ‚Äì Stufe ${stage} (${stufenLabel}) | ${gap.toFixed(1)} Jahre Differenz</strong><br>
<em>Entwicklungsthema: ${angst}</em><br><br>
<u>Alltag:</u> ${impl.alltag}<br>
<u>Schwierigkeit:</u> ${impl.schwierigkeit}<br>
<u>Vergleich Peers:</u> ${impl.peers}`;
}

function calculateDevelopmentalAge(highestStage, stageData, domain) {
    if (highestStage === 0) return { age: 0, stage: 0 };

    const stage = STAGE_DATA[highestStage];
    const sd = stageData[domain][highestStage];

    // Calculate weighted position within stage based on completion percentage
    const completionPercent = sd.erreicht / sd.total;
    const ageRange = stage.ageMax - stage.ageMin;
    const developmentalAge = stage.ageMin + (ageRange * completionPercent);

    return {
        age: Math.round(developmentalAge * 10) / 10,
        stage: highestStage,
        stageLabel: stage.label,
        angst: stage.angst,
        beschreibung: stage.beschreibung,
        completion: Math.round(completionPercent * 100)
    };
}

function exportToWord() {
    const student = getStudentData();
    const today = new Date().toLocaleDateString('de-DE');
    const biologicalAge = calculateAge(student.birthDate);

    // Collect detailed data per domain and stage
    const reportData = {};
    const stageData = {};

    Object.keys(ELDIB_DATA).forEach(domain => {
        const domainData = ELDIB_DATA[domain];
        reportData[domain] = {
            name: domainData.name,
            color: domainData.color,
            code: domainData.code,
            erreicht: [],
            ziele: [],
            totalItems: 0
        };
        stageData[domain] = {};

        domainData.stufen.forEach(stufe => {
            stageData[domain][stufe.nummer] = {
                total: stufe.items.length,
                erreicht: 0,
                ziele: 0,
                stufenziel: stufe.stufenziel
            };

            stufe.items.forEach(item => {
                reportData[domain].totalItems++;
                const status = assessments[domain][item.id];
                if (status.erreicht) {
                    reportData[domain].erreicht.push({ ...item, stufe: stufe.nummer });
                    stageData[domain][stufe.nummer].erreicht++;
                }
                if (status.ziel) {
                    reportData[domain].ziele.push({ ...item, stufe: stufe.nummer });
                    stageData[domain][stufe.nummer].ziele++;
                }
            });
        });
    });

    // Calculate highest achieved stage and developmental age per domain
    const highestStage = {};
    const developmentalAges = {};
    Object.keys(stageData).forEach(domain => {
        highestStage[domain] = 0;
        for (let i = 5; i >= 1; i--) {
            if (stageData[domain][i].erreicht > 0) {
                highestStage[domain] = i;
                break;
            }
        }
        developmentalAges[domain] = calculateDevelopmentalAge(highestStage[domain], stageData, domain);
    });

    // Calculate average developmental age across all domains
    const devAgeValues = Object.values(developmentalAges).map(d => d.age).filter(a => a > 0);
    const avgDevAge = devAgeValues.length > 0 ? devAgeValues.reduce((a, b) => a + b, 0) / devAgeValues.length : 0;

    // Calculate Developmental Quotient (similar to IQ scaling: 100 = age-appropriate)
    let developmentQuotient = null;
    if (biologicalAge && biologicalAge.decimal > 0 && avgDevAge > 0) {
        developmentQuotient = Math.round((avgDevAge / biologicalAge.decimal) * 100);
    }

    // Build HTML content for Word
    let html = `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
    @page { margin: 1.5cm; }
    body {
        font-family: Calibri, Arial, sans-serif;
        font-size: 10pt;
        line-height: 1.3;
        color: #333;
    }
    .header {
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 4px solid #2c3e50;
        padding-bottom: 15px;
    }
    .header h1 {
        font-size: 26pt;
        color: #2c3e50;
        margin: 0 0 5px 0;
        letter-spacing: 2px;
    }
    .header h1 span { color: #3498db; }
    .header p {
        font-size: 11pt;
        color: #666;
        margin: 0;
    }
    .info-box {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .info-grid {
        display: table;
        width: 100%;
    }
    .info-row {
        display: table-row;
    }
    .info-cell {
        display: table-cell;
        padding: 5px 10px;
        width: 25%;
    }
    .info-label {
        font-weight: bold;
        color: #495057;
        font-size: 9pt;
    }
    .info-value {
        color: #212529;
        font-size: 11pt;
    }

    /* ===== ENTWICKLUNGSRASTER ===== */
    .raster-section {
        margin: 25px 0;
        page-break-inside: avoid;
    }
    .raster-title {
        font-size: 14pt;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #3498db;
    }
    .raster-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
    }
    .raster-table th {
        background: #2c3e50;
        color: white;
        padding: 10px 8px;
        font-size: 9pt;
        text-align: center;
        border: 1px solid #2c3e50;
    }
    .raster-table th.domain-col {
        width: 18%;
        text-align: left;
        padding-left: 12px;
    }
    .raster-table th.stage-col {
        width: 16.4%;
    }
    .raster-table td {
        border: 1px solid #dee2e6;
        padding: 8px;
        text-align: center;
        vertical-align: middle;
    }
    .raster-table td.domain-name {
        text-align: left;
        font-weight: bold;
        padding-left: 12px;
    }
    .stage-cell {
        position: relative;
        height: 50px;
    }
    .stage-indicator {
        display: inline-block;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        line-height: 36px;
        font-weight: bold;
        font-size: 11pt;
    }
    .stage-empty {
        background: #f8f9fa;
        color: #adb5bd;
        border: 2px dashed #dee2e6;
    }
    .stage-erreicht {
        background: #27ae60;
        color: white;
        border: 2px solid #1e8449;
    }
    .stage-ziel {
        background: #f39c12;
        color: white;
        border: 2px solid #d68910;
    }
    .stage-mixed {
        background: linear-gradient(135deg, #27ae60 50%, #f39c12 50%);
        color: white;
        border: 2px solid #1e8449;
    }
    .stage-count {
        font-size: 8pt;
        color: #666;
        margin-top: 3px;
    }

    /* ===== FORTSCHRITTSBALKEN ===== */
    .progress-section {
        margin: 25px 0;
    }
    .progress-title {
        font-size: 14pt;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #27ae60;
    }
    .progress-item {
        margin-bottom: 15px;
        page-break-inside: avoid;
    }
    .progress-header {
        display: table;
        width: 100%;
        margin-bottom: 5px;
    }
    .progress-domain {
        display: table-cell;
        font-weight: bold;
        font-size: 11pt;
    }
    .progress-stats {
        display: table-cell;
        text-align: right;
        font-size: 9pt;
        color: #666;
    }
    .progress-bar-container {
        background: #ecf0f1;
        border-radius: 10px;
        height: 24px;
        overflow: hidden;
        border: 1px solid #bdc3c7;
    }
    .progress-bar {
        height: 100%;
        border-radius: 10px 0 0 10px;
        display: inline-block;
        vertical-align: top;
    }
    .progress-bar.erreicht {
        background: linear-gradient(90deg, #27ae60, #2ecc71);
    }
    .progress-bar.ziel {
        background: linear-gradient(90deg, #f39c12, #f1c40f);
    }

    /* ===== ZUSAMMENFASSUNG CARDS ===== */
    .summary-section {
        margin: 25px 0;
    }
    .summary-title {
        font-size: 14pt;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #9b59b6;
    }
    .summary-grid {
        display: table;
        width: 100%;
        table-layout: fixed;
    }
    .summary-card {
        display: table-cell;
        width: 25%;
        padding: 10px;
        text-align: center;
        vertical-align: top;
    }
    .summary-card-inner {
        border: 2px solid;
        border-radius: 10px;
        padding: 15px 10px;
    }
    .summary-icon {
        font-size: 24pt;
        margin-bottom: 5px;
    }
    .summary-number {
        font-size: 28pt;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .summary-label {
        font-size: 9pt;
        color: #666;
    }
    .summary-sublabel {
        font-size: 8pt;
        color: #999;
        margin-top: 3px;
    }

    /* ===== VISUELLER ALTERSVERGLEICH ===== */
    .age-visual-section {
        margin: 25px 0;
    }
    .age-visual-title {
        font-size: 14pt;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #8e44ad;
    }
    .age-visual-row {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    .age-visual-header {
        display: table;
        width: 100%;
        margin-bottom: 10px;
    }
    .age-visual-domain {
        display: table-cell;
        font-weight: bold;
        font-size: 12pt;
    }
    .age-visual-values {
        display: table-cell;
        text-align: right;
        font-size: 10pt;
    }
    .age-bar-table {
        width: 100%;
        border-collapse: collapse;
        height: 30px;
        border-radius: 15px;
        overflow: hidden;
    }
    .age-bar-table td {
        height: 30px;
        padding: 0;
        border: none;
    }
    .age-bar-wrapper {
        position: relative;
        margin-bottom: 5px;
    }
    .age-bar-markers {
        position: relative;
        height: 45px;
        margin-top: -38px;
    }
    .age-bar-marker {
        position: absolute;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        text-align: center;
        line-height: 36px;
        font-weight: bold;
        font-size: 10pt;
        color: white;
        border: 3px solid white;
        margin-left: -18px;
    }
    .age-bar-marker.bio {
        background: #3498db;
    }
    .age-bar-marker.dev {
        background: #9b59b6;
    }
    .age-bar-scale {
        display: table;
        width: 100%;
        font-size: 8pt;
        color: #666;
        margin-top: 15px;
    }
    .age-bar-scale span {
        display: table-cell;
        text-align: center;
    }
    .age-bar-legend {
        margin-top: 10px;
        font-size: 9pt;
        color: #666;
    }
    .age-bar-legend span {
        margin-right: 15px;
    }
    .age-bar-legend .dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 4px;
        vertical-align: middle;
    }
    .age-statement {
        margin-top: 10px;
        padding: 10px 12px;
        background: #fff;
        border-left: 4px solid;
        font-size: 10pt;
        font-style: italic;
        color: #555;
    }

    /* ===== ZIELE MIT INTERVENTIONEN ===== */
    .goal-card {
        background: #fff9e6;
        border: 2px solid #f39c12;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
    }
    .goal-header {
        display: table;
        width: 100%;
        margin-bottom: 8px;
    }
    .goal-id {
        display: table-cell;
        font-weight: bold;
        color: #d68910;
        width: 60px;
    }
    .goal-name {
        display: table-cell;
        font-weight: bold;
        color: #2c3e50;
    }
    .goal-formulation {
        background: #fef9e7;
        border-left: 3px solid #f39c12;
        padding: 8px 12px;
        margin: 8px 0;
        font-style: italic;
        color: #7d6608;
    }
    .goal-formulation-label {
        font-weight: bold;
        font-size: 9pt;
        color: #b7950b;
        font-style: normal;
    }
    .goal-interventions {
        margin-top: 10px;
    }
    .goal-interventions-label {
        font-weight: bold;
        font-size: 9pt;
        color: #27ae60;
        margin-bottom: 5px;
    }
    .goal-intervention-item {
        padding: 4px 0 4px 15px;
        font-size: 10pt;
        color: #333;
        position: relative;
    }
    .goal-intervention-item:before {
        content: "‚Üí";
        position: absolute;
        left: 0;
        color: #27ae60;
    }

    /* ===== DETAILBEREICH ===== */
    .detail-section {
        margin: 30px 0;
    }
    .detail-title {
        font-size: 16pt;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 3px solid #2c3e50;
    }
    .domain-block {
        margin-bottom: 25px;
        page-break-inside: avoid;
    }
    .domain-header {
        padding: 12px 15px;
        color: white;
        font-size: 13pt;
        font-weight: bold;
        border-radius: 6px 6px 0 0;
        margin-bottom: 0;
    }
    .domain-content {
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 6px 6px;
        padding: 15px;
        background: #fafafa;
    }
    .section-header {
        font-size: 11pt;
        font-weight: bold;
        margin: 10px 0 8px 0;
        padding: 6px 10px;
        border-radius: 4px;
    }
    .section-header.erreicht {
        background: #d5f5e3;
        color: #1e8449;
        border-left: 4px solid #27ae60;
    }
    .section-header.ziel {
        background: #fef9e7;
        color: #b7950b;
        border-left: 4px solid #f39c12;
    }
    .item-list {
        margin: 0 0 15px 15px;
    }
    .item-entry {
        padding: 6px 0;
        border-bottom: 1px dotted #ddd;
        font-size: 10pt;
    }
    .item-entry:last-child {
        border-bottom: none;
    }
    .item-id {
        font-weight: bold;
        color: #2c3e50;
        background: #ecf0f1;
        padding: 2px 6px;
        border-radius: 3px;
        margin-right: 8px;
    }
    .item-name {
        font-weight: bold;
    }
    .item-desc {
        color: #555;
        font-size: 9pt;
        margin-left: 5px;
    }
    .no-items {
        color: #999;
        font-style: italic;
        padding: 8px;
    }

    /* ===== LEGENDE ===== */
    .legend {
        margin-top: 20px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 6px;
        font-size: 9pt;
    }
    .legend-title {
        font-weight: bold;
        margin-bottom: 8px;
    }
    .legend-item {
        display: inline-block;
        margin-right: 20px;
    }
    .legend-dot {
        display: inline-block;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        margin-right: 5px;
        vertical-align: middle;
    }

    .footer {
        margin-top: 30px;
        text-align: center;
        color: #888;
        font-size: 9pt;
        border-top: 2px solid #eee;
        padding-top: 15px;
    }

    /* ===== ENTWICKLUNGSPROFIL ===== */
    .profile-section {
        margin: 30px 0;
        page-break-inside: avoid;
    }
    .profile-title {
        font-size: 16pt;
        font-weight: bold;
        color: #8e44ad;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 3px solid #8e44ad;
    }
    .age-comparison-box {
        display: table;
        width: 100%;
        margin-bottom: 25px;
        border: 2px solid #8e44ad;
        border-radius: 12px;
        overflow: hidden;
    }
    .age-box {
        display: table-cell;
        width: 33.33%;
        padding: 20px;
        text-align: center;
        vertical-align: middle;
    }
    .age-box.bio {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
    }
    .age-box.dev {
        background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        color: white;
    }
    .age-box.quotient {
        background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
        color: white;
    }
    .age-box-label {
        font-size: 10pt;
        opacity: 0.9;
        margin-bottom: 5px;
    }
    .age-box-value {
        font-size: 32pt;
        font-weight: bold;
    }
    .age-box-unit {
        font-size: 11pt;
        opacity: 0.8;
    }
    .age-box-sub {
        font-size: 9pt;
        opacity: 0.7;
        margin-top: 5px;
    }

    /* Timeline Visualization */
    .timeline-container {
        margin: 25px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
    }
    .timeline-title {
        font-size: 12pt;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 15px;
    }
    .timeline {
        position: relative;
        height: 60px;
        background: linear-gradient(90deg, #ecf0f1 0%, #bdc3c7 100%);
        border-radius: 30px;
        margin: 20px 0;
    }
    .timeline-scale {
        display: table;
        width: 100%;
        font-size: 8pt;
        color: #666;
        margin-top: 5px;
    }
    .timeline-scale-item {
        display: table-cell;
        text-align: center;
    }
    .timeline-marker {
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 11pt;
        color: white;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .timeline-marker.bio {
        background: #3498db;
    }
    .timeline-marker.dev {
        background: #9b59b6;
    }
    .timeline-label {
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 8pt;
        white-space: nowrap;
    }

    /* Domain Profile Cards */
    .domain-profile-grid {
        display: table;
        width: 100%;
        table-layout: fixed;
        margin: 20px 0;
    }
    .domain-profile-card {
        display: table-cell;
        padding: 8px;
        vertical-align: top;
    }
    .domain-profile-inner {
        border: 2px solid;
        border-radius: 10px;
        padding: 12px;
        background: white;
        height: 100%;
    }
    .domain-profile-header {
        font-size: 11pt;
        font-weight: bold;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 2px solid;
    }
    .domain-profile-ages {
        margin-bottom: 10px;
    }
    .domain-profile-age-row {
        display: table;
        width: 100%;
        font-size: 9pt;
        padding: 3px 0;
    }
    .domain-profile-age-label {
        display: table-cell;
        width: 60%;
        color: #666;
    }
    .domain-profile-age-value {
        display: table-cell;
        text-align: right;
        font-weight: bold;
    }
    .domain-profile-bar {
        height: 8px;
        background: #ecf0f1;
        border-radius: 4px;
        overflow: hidden;
        margin: 8px 0;
    }
    .domain-profile-bar-fill {
        height: 100%;
        border-radius: 4px;
    }
    .domain-profile-angst {
        font-size: 9pt;
        padding: 8px;
        background: #fef9e7;
        border-radius: 6px;
        border-left: 3px solid #f39c12;
        margin-top: 10px;
    }
    .domain-profile-angst-label {
        font-weight: bold;
        color: #d68910;
        font-size: 8pt;
    }
    .domain-profile-angst-value {
        color: #7d6608;
        margin-top: 3px;
    }

    /* Interpretation Box */
    .interpretation-box {
        margin: 25px 0;
        padding: 20px;
        border-radius: 10px;
        border: 2px solid;
    }
    .interpretation-box.ahead {
        background: #e8f8f5;
        border-color: #1abc9c;
    }
    .interpretation-box.appropriate {
        background: #eafaf1;
        border-color: #27ae60;
    }
    .interpretation-box.delayed {
        background: #fef9e7;
        border-color: #f39c12;
    }
    .interpretation-box.significant {
        background: #fdedec;
        border-color: #e74c3c;
    }
    .interpretation-title {
        font-size: 12pt;
        font-weight: bold;
        margin-bottom: 10px;
    }
    .interpretation-text {
        font-size: 10pt;
        line-height: 1.5;
    }
</style>
</head>
<body>

<div class="header">
    <h1>ELD<span>i</span>B</h1>
    <p>Entwicklungsp√§dagogischer Lernziel-Diagnose-Bogen</p>
</div>

<div class="info-box">
    <div class="info-grid">
        <div class="info-row">
            <div class="info-cell">
                <div class="info-label">Name</div>
                <div class="info-value">${student.name || '-'}</div>
            </div>
            <div class="info-cell">
                <div class="info-label">Geburtsdatum</div>
                <div class="info-value">${student.birthDate ? new Date(student.birthDate).toLocaleDateString('de-DE') : '-'}</div>
            </div>
            <div class="info-cell">
                <div class="info-label">F√∂rderort</div>
                <div class="info-value">${student.foerderort || '-'}</div>
            </div>
            <div class="info-cell">
                <div class="info-label">Datum</div>
                <div class="info-value">${student.assessmentDate ? new Date(student.assessmentDate).toLocaleDateString('de-DE') : '-'}</div>
            </div>
        </div>
        <div class="info-row">
            <div class="info-cell" colspan="4">
                <div class="info-label">Einsch√§tzende Person</div>
                <div class="info-value">${student.assessorName || '-'}</div>
            </div>
        </div>
    </div>
</div>

<!-- ===== ENTWICKLUNGSPROFIL ===== -->
<div class="profile-section">
    <div class="profile-title">Sozio-Emotionales Entwicklungsprofil</div>

    <div class="age-comparison-box">
        <div class="age-box bio">
            <div class="age-box-label">Biologisches Alter</div>
            <div class="age-box-value">${biologicalAge ? biologicalAge.years : '-'}</div>
            <div class="age-box-unit">${biologicalAge ? 'Jahre' : ''}</div>
            <div class="age-box-sub">${biologicalAge ? `${biologicalAge.months} Monate` : 'Geburtsdatum fehlt'}</div>
        </div>
        <div class="age-box dev">
            <div class="age-box-label">√ò Entwicklungsalter</div>
            <div class="age-box-value">${avgDevAge > 0 ? avgDevAge.toFixed(1) : '-'}</div>
            <div class="age-box-unit">${avgDevAge > 0 ? 'Jahre' : ''}</div>
            <div class="age-box-sub">√ºber alle Bereiche</div>
        </div>
        <div class="age-box quotient">
            <div class="age-box-label">Entwicklungsquotient</div>
            <div class="age-box-value">${developmentQuotient !== null ? developmentQuotient : '-'}</div>
            <div class="age-box-unit">${developmentQuotient !== null ? '%' : ''}</div>
            <div class="age-box-sub">${developmentQuotient !== null ? (developmentQuotient >= 100 ? 'altersgem√§√ü oder dar√ºber' : 'unter Altersnorm') : '100% = altersgem√§√ü'}</div>
        </div>
    </div>

    <div class="domain-profile-grid">`;

    // Domain profile cards - mit Entwicklungstrend
    const hasMultipleEvals = currentProfileId && allProfiles[currentProfileId] && allProfiles[currentProfileId].evaluations.length > 1;
    let previousEvalAges = {};
    if (hasMultipleEvals) {
        const profile = allProfiles[currentProfileId];
        const sortedEvals = profile.evaluations.sort((a, b) => new Date(a.date) - new Date(b.date));
        if (sortedEvals.length >= 2) {
            previousEvalAges = sortedEvals[sortedEvals.length - 2].developmentalAges || {};
        }
    }

    Object.keys(reportData).forEach(domain => {
        const data = reportData[domain];
        const devAge = developmentalAges[domain];
        const bioAge = biologicalAge ? biologicalAge.decimal : 0;
        const barPercent = bioAge > 0 && devAge.age > 0 ? Math.min(100, (devAge.age / bioAge) * 100) : 0;

        // Trend berechnen
        let trendText = '-';
        let trendColor = '#666';
        if (hasMultipleEvals && previousEvalAges[domain]) {
            const diff = devAge.age - previousEvalAges[domain];
            if (diff > 0) {
                trendText = `+${diff.toFixed(1)} J.`;
                trendColor = '#27ae60';
            } else if (diff < 0) {
                trendText = `${diff.toFixed(1)} J.`;
                trendColor = '#e74c3c';
            } else {
                trendText = '¬±0';
                trendColor = '#888';
            }
        }

        html += `
        <div class="domain-profile-card">
            <div class="domain-profile-inner" style="border-color: ${data.color};">
                <div class="domain-profile-header" style="color: ${data.color}; border-color: ${data.color};">${data.name}</div>
                <div class="domain-profile-ages">
                    <div class="domain-profile-age-row">
                        <span class="domain-profile-age-label">Entwicklungsalter:</span>
                        <span class="domain-profile-age-value" style="color: ${data.color};">${devAge.age > 0 ? devAge.age + ' J.' : '-'}</span>
                    </div>
                    <div class="domain-profile-age-row">
                        <span class="domain-profile-age-label">Stufe:</span>
                        <span class="domain-profile-age-value">${devAge.stage > 0 ? devAge.stage + ' (' + devAge.stageLabel + ')' : '-'}</span>
                    </div>
                    ${hasMultipleEvals ? `
                    <div class="domain-profile-age-row">
                        <span class="domain-profile-age-label">Fortschritt:</span>
                        <span class="domain-profile-age-value" style="color: ${trendColor}; font-weight: bold;">${trendText}</span>
                    </div>` : ''}
                </div>
                <div class="domain-profile-bar">
                    <div class="domain-profile-bar-fill" style="width: ${barPercent}%; background: ${data.color};"></div>
                </div>
                ${devAge.stage > 0 ? `
                <div class="domain-profile-angst">
                    <div class="domain-profile-angst-label">Entwicklungsangst:</div>
                    <div class="domain-profile-angst-value">${devAge.angst}</div>
                </div>` : ''}
            </div>
        </div>`;
    });

    html += `
    </div>`;

    // Interpretation based on quotient - RESSOURCENORIENTIERT
    if (developmentQuotient !== null) {
        let interpClass, interpTitle, interpText;

        if (developmentQuotient >= 100) {
            interpClass = 'appropriate';
            interpTitle = '‚úì St√§rken und Ressourcen';
            interpText = `Das Kind zeigt in der sozio-emotionalen Entwicklung viele St√§rken. Der Entwicklungsquotient von ${developmentQuotient}% zeigt eine positive Entwicklungsdynamik. Die erreichten Kompetenzen bilden eine solide Grundlage f√ºr weitere Entwicklungsschritte.`;
        } else if (developmentQuotient >= 75) {
            interpClass = 'delayed';
            interpTitle = '‚Üí Entwicklungspotenzial mit gezielter F√∂rderung';
            interpText = `Das Kind verf√ºgt √ºber wichtige Basiskompetenzen und zeigt Entwicklungspotenzial. Mit gezielter F√∂rderung der definierten Ziele kann das Kind seine St√§rken weiter ausbauen. Die bestehenden Ressourcen bieten gute Ankn√ºpfungspunkte f√ºr die p√§dagogische Arbeit.`;
        } else if (developmentQuotient >= 50) {
            interpClass = 'delayed';
            interpTitle = '‚Üí Intensive F√∂rderung zur St√§rkung der Basiskompetenzen';
            interpText = `Das Kind befindet sich auf einem fr√ºheren Entwicklungsstand und braucht intensive Unterst√ºtzung. Die bereits erreichten Kompetenzen zeigen, dass Entwicklung m√∂glich ist. Mit entwicklungsangemessener F√∂rderung und Bearbeitung der Entwicklungs√§ngste kann das Kind schrittweise vorankommen.`;
        } else {
            interpClass = 'significant';
            interpTitle = '‚Üí Multiprofessionelle Begleitung zur Entwicklungsf√∂rderung';
            interpText = `Das Kind ben√∂tigt intensive Unterst√ºtzung auf den grundlegenden Entwicklungsstufen. Jeder kleine Fortschritt ist ein Erfolg. Multiprofessionelle Zusammenarbeit und ein wertsch√§tzender, ressourcenorientierter Ansatz sind der Schl√ºssel zur F√∂rderung.`;
        }

        html += `
    <div class="interpretation-box ${interpClass}">
        <div class="interpretation-title">${interpTitle}</div>
        <div class="interpretation-text">${interpText}</div>
    </div>`;
    }

    // Stage reference table
    html += `
    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <div style="font-weight: bold; margin-bottom: 10px; font-size: 11pt;">Stufenreferenz nach ELDiB</div>
        <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
            <tr style="background: #2c3e50; color: white;">
                <th style="padding: 8px; text-align: left; width: 15%;">Stufe</th>
                <th style="padding: 8px; text-align: left; width: 15%;">Alter</th>
                <th style="padding: 8px; text-align: left; width: 25%;">Entwicklungsangst</th>
                <th style="padding: 8px; text-align: left; width: 45%;">Entwicklungsaufgabe</th>
            </tr>
            <tr style="background: #ecf0f1;"><td style="padding: 8px; font-weight: bold;">1</td><td style="padding: 8px;">0-2 Jahre</td><td style="padding: 8px; color: #c0392b;">Verlassenheit</td><td style="padding: 8px;">Grundlegendes Vertrauen aufbauen</td></tr>
            <tr><td style="padding: 8px; font-weight: bold;">2</td><td style="padding: 8px;">2-5 Jahre</td><td style="padding: 8px; color: #c0392b;">Unzul√§nglichkeit</td><td style="padding: 8px;">Autonomie und Selbstwirksamkeit entwickeln</td></tr>
            <tr style="background: #ecf0f1;"><td style="padding: 8px; font-weight: bold;">3</td><td style="padding: 8px;">6-9 Jahre</td><td style="padding: 8px; color: #c0392b;">Schuld</td><td style="padding: 8px;">Initiative und Kompetenz erwerben</td></tr>
            <tr><td style="padding: 8px; font-weight: bold;">4</td><td style="padding: 8px;">10-12 Jahre</td><td style="padding: 8px; color: #c0392b;">Konflikt</td><td style="padding: 8px;">Soziale Rollen und Beziehungen gestalten</td></tr>
            <tr style="background: #ecf0f1;"><td style="padding: 8px; font-weight: bold;">5</td><td style="padding: 8px;">13-16 Jahre</td><td style="padding: 8px; color: #c0392b;">Identit√§t</td><td style="padding: 8px;">Identit√§t und Werte entwickeln</td></tr>
        </table>
    </div>

    <!-- ===== VISUELLER ALTERSVERGLEICH MIT ENTWICKLUNGSVERLAUF ===== -->
    <div class="age-visual-section">
        <div class="age-visual-title">Visueller Altersvergleich pro Bereich${hasMultipleEvals ? ' (mit Entwicklungsverlauf)' : ''}</div>`;

    // Alle Evaluationen f√ºr den Verlauf holen
    let allEvaluations = [];
    const domainShades = {
        verhalten: ['#fadbd8', '#f5b7b1', '#f1948a', '#ec7063', '#e74c3c'],
        kommunikation: ['#d4e6f1', '#a9cce3', '#7fb3d5', '#5499c7', '#3498db'],
        sozialisation: ['#d4efdf', '#a9dfbf', '#7dcea0', '#52be80', '#27ae60'],
        kognition: ['#e8daef', '#d2b4de', '#bb8fce', '#a569bd', '#9b59b6']
    };
    if (hasMultipleEvals) {
        const profile = allProfiles[currentProfileId];
        allEvaluations = profile.evaluations.sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    // Visual age bars for each domain with individual statements
    const maxAge = 18; // Maximum age for scale
    Object.keys(reportData).forEach(domain => {
        const data = reportData[domain];
        const devAge = developmentalAges[domain];
        const bioAge = biologicalAge ? biologicalAge.decimal : 0;

        const bioPercent = bioAge > 0 ? Math.min(100, (bioAge / maxAge) * 100) : 0;
        const devPercent = devAge.age > 0 ? Math.min(100, (devAge.age / maxAge) * 100) : 0;

        const gap = bioAge > 0 && devAge.age > 0 ? bioAge - devAge.age : null;
        const gapText = gap !== null ? (gap > 0 ? `${gap.toFixed(1)} Jahre Differenz` : 'Altersgem√§√ü') : '';
        const gapColor = gap !== null ? (gap > 2 ? '#e74c3c' : gap > 0 ? '#f39c12' : '#27ae60') : '#666';

        // Generate individual statement for this domain
        const domainStatement = generateDomainStatement(domain, data.name, bioAge, devAge.age, gap, devAge.stage, devAge.angst, stageData[domain]);

        html += `
        <div class="age-visual-row">
            <div class="age-visual-header">
                <span class="age-visual-domain" style="color: ${data.color};">${data.name}</span>
                <span class="age-visual-values" style="color: ${gapColor}; font-weight: bold;">${gapText}</span>
            </div>
            <table style="width: 100%; border-collapse: collapse; margin: 8px 0;">
                <tr>
                    <td style="width: 140px; padding: 4px 10px 4px 0; font-size: 10pt; color: #95a5a6; font-weight: bold;">Bio. Alter:</td>
                    <td style="padding: 4px;">
                        <table style="width: 100%; height: 18px; border-collapse: collapse; border: 1px solid #bdc3c7;">
                            <tr>
                                <td style="width: ${bioPercent}%; background: #95a5a6; height: 18px;"></td>
                                <td style="background: #f5f5f5; height: 18px;"></td>
                            </tr>
                        </table>
                    </td>
                    <td style="width: 55px; text-align: right; font-size: 10pt; font-weight: bold; color: #95a5a6;">${bioAge > 0 ? bioAge.toFixed(1) + ' J.' : '-'}</td>
                </tr>`;

        // Wenn mehrere Evaluationen existieren, zeige alle Entwicklungsbalken
        if (hasMultipleEvals && allEvaluations.length > 1) {
            const evalCount = allEvaluations.length;
            const shades = domainShades[domain] || [data.color];

            allEvaluations.forEach((evaluation, idx) => {
                const evalDevAge = evaluation.developmentalAges?.[domain] || 0;
                const evalPercent = Math.min(100, (evalDevAge / maxAge) * 100);
                const evalDate = new Date(evaluation.date).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: '2-digit' });
                const shadeIndex = Math.round((idx / (evalCount - 1)) * 4);
                const barColor = shades[shadeIndex];
                const isLast = idx === evalCount - 1;

                html += `
                <tr>
                    <td style="width: 140px; padding: 3px 10px 3px 0; font-size: 9pt; color: ${isLast ? data.color : '#888'}; ${isLast ? 'font-weight: bold;' : ''}">${evalDate}${isLast ? ' (aktuell)' : ''}:</td>
                    <td style="padding: 3px;">
                        <table style="width: 100%; height: ${isLast ? '20' : '14'}px; border-collapse: collapse; border: 1px solid ${isLast ? '#999' : '#ccc'};">
                            <tr>
                                <td style="width: ${evalPercent}%; background-color: ${barColor}; height: ${isLast ? '20' : '14'}px;"></td>
                                <td style="background: #f8f8f8; height: ${isLast ? '20' : '14'}px;"></td>
                            </tr>
                        </table>
                    </td>
                    <td style="width: 55px; text-align: right; font-size: ${isLast ? '10' : '9'}pt; ${isLast ? 'font-weight: bold;' : ''} color: ${isLast ? data.color : '#666'};">${evalDevAge.toFixed(1)} J.</td>
                </tr>`;
            });
        } else {
            // Nur aktuelles Entwicklungsalter
            html += `
                <tr>
                    <td style="width: 140px; padding: 4px 10px 4px 0; font-size: 10pt; color: ${data.color}; font-weight: bold;">Entw. Alter:</td>
                    <td style="padding: 4px;">
                        <table style="width: 100%; height: 20px; border-collapse: collapse; border: 1px solid #bdc3c7;">
                            <tr>
                                <td style="width: ${devPercent}%; background: ${data.color}; height: 20px;"></td>
                                <td style="background: #f5f5f5; height: 20px;"></td>
                            </tr>
                        </table>
                    </td>
                    <td style="width: 55px; text-align: right; font-size: 10pt; font-weight: bold; color: ${data.color};">${devAge.age > 0 ? devAge.age.toFixed(1) + ' J.' : '-'}</td>
                </tr>`;
        }

        html += `
            </table>
            <table style="width: 100%; font-size: 8pt; color: #999; margin-left: 140px;">
                <tr>
                    <td style="width: 11%;">0</td>
                    <td style="width: 11%;">2</td>
                    <td style="width: 17%;">5</td>
                    <td style="width: 22%;">9</td>
                    <td style="width: 17%;">12</td>
                    <td style="width: 22%;">18 J.</td>
                </tr>
            </table>
            <div style="margin-top: 8px; padding: 10px 12px; background: #fff; border-left: 4px solid ${gapColor}; font-size: 10pt; color: #333;">
                ${domainStatement}
            </div>
        </div>`;
    });

    // Legende wenn Verlauf vorhanden
    if (hasMultipleEvals) {
        html += `
        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 9pt; color: #666;">
            <span style="display: inline-block; width: 14px; height: 14px; background: #95a5a6; vertical-align: middle; margin-right: 5px; border: 1px solid #bbb;"></span> Biologisches Alter |
            <span style="margin-left: 15px;">Farbverlauf hell ‚Üí dunkel = √§ltere ‚Üí neuere Evaluation</span>
        </div>`;
    }

    html += `
    </div>
</div>

<!-- ===== DETAILIERTE AUFLISTUNG ===== -->
<div class="detail-section">
    <div class="detail-title">Detaillierte Auflistung</div>`;

    Object.keys(reportData).forEach(domain => {
        const data = reportData[domain];

        // Nur die letzten 10 erreichten Items anzeigen (h√∂chste Stufen zuerst)
        const sortedErreicht = [...data.erreicht].sort((a, b) => b.stufe - a.stufe);
        const last10Erreicht = sortedErreicht.slice(0, 10);
        const hasMore = data.erreicht.length > 10;

        html += `
    <div class="domain-block">
        <div class="domain-header" style="background-color: ${data.color};">${data.name}</div>
        <div class="domain-content">
            <div class="section-header erreicht">‚úì Erreichte Kompetenzen (${last10Erreicht.length} von ${data.erreicht.length} angezeigt)</div>
            <div class="item-list">`;

        if (last10Erreicht.length > 0) {
            last10Erreicht.forEach(item => {
                html += `
                <div class="item-entry">
                    <span class="item-id">${item.id}</span>
                    <span class="item-name">${item.name}</span>
                    <span class="item-desc">‚Äì ${item.beschreibung}</span>
                </div>`;
            });
            if (hasMore) {
                html += `<div style="font-size: 9pt; color: #888; font-style: italic; margin-top: 8px;">... und ${data.erreicht.length - 10} weitere erreichte Items</div>`;
            }
        } else {
            html += `<div class="no-items">Keine Items markiert</div>`;
        }

        html += `
            </div>
            <div class="section-header ziel">‚óé Aktuelle F√∂rderziele (${data.ziele.length})</div>
            <div class="item-list">`;

        if (data.ziele.length > 0) {
            data.ziele.forEach(item => {
                const interventionData = getInterventionData(item.id);
                html += `
                <div class="goal-card">
                    <div class="goal-header">
                        <span class="goal-id">${item.id}</span>
                        <span class="goal-name">${item.name}</span>
                    </div>
                    <div style="font-size: 10pt; color: #555; margin-bottom: 8px;">${item.beschreibung}</div>
                    <div class="goal-formulation">
                        <div class="goal-formulation-label">Zielformulierung f√ºr das Kind:</div>
                        ‚Äû${interventionData.zielformulierung}"
                    </div>
                    <div class="goal-interventions">
                        <div class="goal-interventions-label">M√∂gliche p√§dagogische Interventionen:</div>
                        ${interventionData.interventionen.map(int => `<div class="goal-intervention-item">${int}</div>`).join('')}
                    </div>
                </div>`;
            });
        } else {
            html += `<div class="no-items">Keine Ziele definiert</div>`;
        }

        html += `
            </div>
        </div>
    </div>`;
    });

    html += `
</div>`;

    html += `
<div class="footer">
    <strong>ELDiB Digital</strong> | Erstellt am ${today} | CDSE - Centre pour le D√©veloppement Socio-√âmotionnel
</div>

</body>
</html>`;

    // Create and download the file
    const blob = new Blob(['\ufeff' + html], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `ELDiB_${(student.name || 'Evaluation').replace(/\s+/g, '_')}_${today.replace(/\./g, '-')}.doc`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// ==========================================
// Initialize
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    // Neue Profile laden
    loadAllProfiles();
    updateProfileDropdown();

    // Alte Daten f√ºr Kompatibilit√§t laden
    loadFromLocalStorage();

    renderAllDomains();
    updateStats();
    updateEvaluationUI();

    // Auto-save on input change
    document.querySelectorAll('.student-grid input').forEach(input => {
        input.addEventListener('change', saveToLocalStorage);
    });

    // Geburtsdatum-√Ñnderung: Re-render um Bio-Alter-Sperre zu aktualisieren
    document.getElementById('birthDate')?.addEventListener('change', () => {
        renderAllDomains();
    });
});
    </script>
</body>
</html>
